<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Patrick Laub">

<title>AI for Actuaries - Recurrent Neural Networks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Exercises/sydney-airport-temperature.html" rel="next">
<link href="../Exercises/police-reports.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Module 5</a></li><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Recurrent Neural Networks</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">AI for Actuaries</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Module 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-1-Artificial-Intelligence/course-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-1-Artificial-Intelligence/artificial-intelligence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Artificial Intelligence</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-1-Artificial-Intelligence/python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/python-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Intro Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/python-for-data-science-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Python for Data Science</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Exercises/chess-ai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise: Chess AI</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Module 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-2-Deep-Learning-Keras/project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project Details</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-2-Deep-Learning-Keras/deep-learning-keras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deep Learning with Keras</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-3-Tabular-Data/categorical-variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Categorical Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-3-Tabular-Data/classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/forward-pass-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Forward Pass</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/matplotlib-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Matplotlib</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Exercises/victorian-crash-severity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise: Victorian Car Crash Severity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Exercises/french-motor-frequency.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise: French Motor Claim Frequency</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Module 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-4-Computer-Vision/computer-vision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computer Vision</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/optimisation-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Optimisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/latex-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Markdown</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Exercises/hurricane-damage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise: Aerial Photos of Hurricane Damage</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Module 4</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-5-Natural-Language-Processing/natural-language-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Natural Language Processing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Exercises/police-reports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise: Police Reports of US Car Crashes</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Module 5</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Recurrent Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Exercises/sydney-airport-temperature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exercise: Sydney Temperature Forecasting</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Module 6</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-6-Distributional-Regression/optimisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-6-Distributional-Regression/distributional-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributional Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/backpropagation-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Backpropagation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Labs/distributional-regression-lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab: Distributional Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Module 7</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-9-Advanced-Topics/interpretability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interpretability</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">Module 8</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-8-Generative-Networks/generative-networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generative Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-8-Generative-Networks/gans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generative Adversarial Networks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">Module 9</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-9-Advanced-Topics/next-steps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Next Steps</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#time-series" id="toc-time-series" class="nav-link active" data-scroll-target="#time-series">Time Series</a>
  <ul class="collapse">
  <li><a href="#tabular-data-vs-time-series-data" id="toc-tabular-data-vs-time-series-data" class="nav-link" data-scroll-target="#tabular-data-vs-time-series-data">Tabular data vs time series data</a></li>
  <li><a href="#attributes-of-time-series-data" id="toc-attributes-of-time-series-data" class="nav-link" data-scroll-target="#attributes-of-time-series-data">Attributes of time series data</a></li>
  <li><a href="#australian-financial-stocks" id="toc-australian-financial-stocks" class="nav-link" data-scroll-target="#australian-financial-stocks">Australian financial stocks</a></li>
  <li><a href="#plot" id="toc-plot" class="nav-link" data-scroll-target="#plot">Plot</a></li>
  <li><a href="#data-types-and-na-values" id="toc-data-types-and-na-values" class="nav-link" data-scroll-target="#data-types-and-na-values">Data types and NA values</a></li>
  <li><a href="#set-the-index-to-the-date" id="toc-set-the-index-to-the-date" class="nav-link" data-scroll-target="#set-the-index-to-the-date">Set the index to the date</a></li>
  <li><a href="#plot-ii" id="toc-plot-ii" class="nav-link" data-scroll-target="#plot-ii">Plot II</a></li>
  <li><a href="#can-index-using-dates-i" id="toc-can-index-using-dates-i" class="nav-link" data-scroll-target="#can-index-using-dates-i">Can index using dates I</a></li>
  <li><a href="#can-index-using-dates-ii" id="toc-can-index-using-dates-ii" class="nav-link" data-scroll-target="#can-index-using-dates-ii">Can index using dates II</a></li>
  <li><a href="#can-look-at-the-first-differences" id="toc-can-look-at-the-first-differences" class="nav-link" data-scroll-target="#can-look-at-the-first-differences">Can look at the first differences</a></li>
  <li><a href="#can-look-at-the-percentage-changes" id="toc-can-look-at-the-percentage-changes" class="nav-link" data-scroll-target="#can-look-at-the-percentage-changes">Can look at the percentage changes</a></li>
  <li><a href="#focus-on-one-stock" id="toc-focus-on-one-stock" class="nav-link" data-scroll-target="#focus-on-one-stock">Focus on one stock</a></li>
  <li><a href="#fill-in-the-missing-values" id="toc-fill-in-the-missing-values" class="nav-link" data-scroll-target="#fill-in-the-missing-values">Fill in the missing values</a></li>
  </ul></li>
  <li><a href="#baseline-forecasts" id="toc-baseline-forecasts" class="nav-link" data-scroll-target="#baseline-forecasts">Baseline forecasts</a>
  <ul class="collapse">
  <li><a href="#persistence-forecast" id="toc-persistence-forecast" class="nav-link" data-scroll-target="#persistence-forecast">Persistence forecast</a></li>
  <li><a href="#trend" id="toc-trend" class="nav-link" data-scroll-target="#trend">Trend</a></li>
  <li><a href="#trend-forecasts" id="toc-trend-forecasts" class="nav-link" data-scroll-target="#trend-forecasts">Trend forecasts</a></li>
  <li><a href="#which-is-better" id="toc-which-is-better" class="nav-link" data-scroll-target="#which-is-better">Which is better?</a></li>
  <li><a href="#use-the-history" id="toc-use-the-history" class="nav-link" data-scroll-target="#use-the-history">Use the history</a></li>
  <li><a href="#lagged-time-series" id="toc-lagged-time-series" class="nav-link" data-scroll-target="#lagged-time-series">Lagged time series</a></li>
  <li><a href="#split-into-training-and-testing" id="toc-split-into-training-and-testing" class="nav-link" data-scroll-target="#split-into-training-and-testing">Split into training and testing</a></li>
  <li><a href="#inspect-the-split-data" id="toc-inspect-the-split-data" class="nav-link" data-scroll-target="#inspect-the-split-data">Inspect the split data</a></li>
  <li><a href="#plot-the-split" id="toc-plot-the-split" class="nav-link" data-scroll-target="#plot-the-split">Plot the split</a></li>
  <li><a href="#train-on-more-recent-data" id="toc-train-on-more-recent-data" class="nav-link" data-scroll-target="#train-on-more-recent-data">Train on more recent data</a></li>
  <li><a href="#rescale-by-eyeballing-it" id="toc-rescale-by-eyeballing-it" class="nav-link" data-scroll-target="#rescale-by-eyeballing-it">Rescale by eyeballing it</a></li>
  <li><a href="#fit-a-linear-model" id="toc-fit-a-linear-model" class="nav-link" data-scroll-target="#fit-a-linear-model">Fit a linear model</a></li>
  <li><a href="#inverse-transform-the-forecasts" id="toc-inverse-transform-the-forecasts" class="nav-link" data-scroll-target="#inverse-transform-the-forecasts">Inverse-transform the forecasts</a></li>
  <li><a href="#careful-with-the-metrics" id="toc-careful-with-the-metrics" class="nav-link" data-scroll-target="#careful-with-the-metrics">Careful with the metrics</a></li>
  </ul></li>
  <li><a href="#multi-step-forecasts" id="toc-multi-step-forecasts" class="nav-link" data-scroll-target="#multi-step-forecasts">Multi-step forecasts</a>
  <ul class="collapse">
  <li><a href="#comparing-apples-to-apples" id="toc-comparing-apples-to-apples" class="nav-link" data-scroll-target="#comparing-apples-to-apples">Comparing apples to apples</a></li>
  <li><a href="#autoregressive-forecasts" id="toc-autoregressive-forecasts" class="nav-link" data-scroll-target="#autoregressive-forecasts">Autoregressive forecasts</a></li>
  <li><a href="#autoregressive-forecasting-function" id="toc-autoregressive-forecasting-function" class="nav-link" data-scroll-target="#autoregressive-forecasting-function">Autoregressive forecasting function</a></li>
  <li><a href="#look-at-the-autoregressive-linear-forecasts" id="toc-look-at-the-autoregressive-linear-forecasts" class="nav-link" data-scroll-target="#look-at-the-autoregressive-linear-forecasts">Look at the autoregressive linear forecasts</a></li>
  <li><a href="#metrics" id="toc-metrics" class="nav-link" data-scroll-target="#metrics">Metrics</a></li>
  <li><a href="#prefer-only-short-windows" id="toc-prefer-only-short-windows" class="nav-link" data-scroll-target="#prefer-only-short-windows">Prefer only short windows</a></li>
  </ul></li>
  <li><a href="#neural-network-forecasts" id="toc-neural-network-forecasts" class="nav-link" data-scroll-target="#neural-network-forecasts">Neural network forecasts</a>
  <ul class="collapse">
  <li><a href="#simple-feedforward-neural-network" id="toc-simple-feedforward-neural-network" class="nav-link" data-scroll-target="#simple-feedforward-neural-network">Simple feedforward neural network</a></li>
  <li><a href="#forecast-and-plot" id="toc-forecast-and-plot" class="nav-link" data-scroll-target="#forecast-and-plot">Forecast and plot</a></li>
  <li><a href="#autoregressive-forecasts-1" id="toc-autoregressive-forecasts-1" class="nav-link" data-scroll-target="#autoregressive-forecasts-1">Autoregressive forecasts</a></li>
  <li><a href="#metrics-1" id="toc-metrics-1" class="nav-link" data-scroll-target="#metrics-1">Metrics</a></li>
  </ul></li>
  <li><a href="#recurrent-neural-networks" id="toc-recurrent-neural-networks" class="nav-link" data-scroll-target="#recurrent-neural-networks">Recurrent Neural Networks</a>
  <ul class="collapse">
  <li><a href="#basic-facts-of-rnns" id="toc-basic-facts-of-rnns" class="nav-link" data-scroll-target="#basic-facts-of-rnns">Basic facts of RNNs</a></li>
  <li><a href="#applications" id="toc-applications" class="nav-link" data-scroll-target="#applications">Applications</a></li>
  <li><a href="#origin-of-the-name-of-rnns" id="toc-origin-of-the-name-of-rnns" class="nav-link" data-scroll-target="#origin-of-the-name-of-rnns">Origin of the name of RNNs</a></li>
  <li><a href="#diagram-of-an-rnn-cell" id="toc-diagram-of-an-rnn-cell" class="nav-link" data-scroll-target="#diagram-of-an-rnn-cell">Diagram of an RNN cell</a></li>
  <li><a href="#a-simplernn-cell" id="toc-a-simplernn-cell" class="nav-link" data-scroll-target="#a-simplernn-cell">A SimpleRNN cell</a></li>
  <li><a href="#lstm-internals" id="toc-lstm-internals" class="nav-link" data-scroll-target="#lstm-internals">LSTM internals</a></li>
  <li><a href="#gru-internals" id="toc-gru-internals" class="nav-link" data-scroll-target="#gru-internals">GRU internals</a></li>
  </ul></li>
  <li><a href="#rnn-demo" id="toc-rnn-demo" class="nav-link" data-scroll-target="#rnn-demo">RNN Demo</a>
  <ul class="collapse">
  <li><a href="#simplernn" id="toc-simplernn" class="nav-link" data-scroll-target="#simplernn">SimpleRNN</a></li>
  <li><a href="#forecast-and-plot-1" id="toc-forecast-and-plot-1" class="nav-link" data-scroll-target="#forecast-and-plot-1">Forecast and plot</a></li>
  <li><a href="#multi-step-forecasts-1" id="toc-multi-step-forecasts-1" class="nav-link" data-scroll-target="#multi-step-forecasts-1">Multi-step forecasts</a></li>
  <li><a href="#metrics-2" id="toc-metrics-2" class="nav-link" data-scroll-target="#metrics-2">Metrics</a></li>
  <li><a href="#gru" id="toc-gru" class="nav-link" data-scroll-target="#gru">GRU</a></li>
  <li><a href="#forecast-and-plot-2" id="toc-forecast-and-plot-2" class="nav-link" data-scroll-target="#forecast-and-plot-2">Forecast and plot</a></li>
  <li><a href="#multi-step-forecasts-2" id="toc-multi-step-forecasts-2" class="nav-link" data-scroll-target="#multi-step-forecasts-2">Multi-step forecasts</a></li>
  <li><a href="#metrics-3" id="toc-metrics-3" class="nav-link" data-scroll-target="#metrics-3">Metrics</a></li>
  </ul></li>
  <li><a href="#simplernn-maths" id="toc-simplernn-maths" class="nav-link" data-scroll-target="#simplernn-maths">SimpleRNN maths</a>
  <ul class="collapse">
  <li><a href="#the-rank-of-a-time-series" id="toc-the-rank-of-a-time-series" class="nav-link" data-scroll-target="#the-rank-of-a-time-series">The rank of a time series</a></li>
  <li><a href="#multivariate-time-series" id="toc-multivariate-time-series" class="nav-link" data-scroll-target="#multivariate-time-series">Multivariate time series</a></li>
  <li><a href="#simplernn-1" id="toc-simplernn-1" class="nav-link" data-scroll-target="#simplernn-1">SimpleRNN</a></li>
  <li><a href="#simplernn-in-batches" id="toc-simplernn-in-batches" class="nav-link" data-scroll-target="#simplernn-in-batches">SimpleRNN (in batches)</a></li>
  <li><a href="#simple-keras-demo" id="toc-simple-keras-demo" class="nav-link" data-scroll-target="#simple-keras-demo">Simple Keras demo</a></li>
  <li><a href="#keras-simplernn" id="toc-keras-simplernn" class="nav-link" data-scroll-target="#keras-simplernn">Keras’ SimpleRNN</a></li>
  <li><a href="#simplernn-weights" id="toc-simplernn-weights" class="nav-link" data-scroll-target="#simplernn-weights">SimpleRNN weights</a></li>
  </ul></li>
  <li><a href="#more-complex-rnns" id="toc-more-complex-rnns" class="nav-link" data-scroll-target="#more-complex-rnns">More complex RNNs</a>
  <ul class="collapse">
  <li><a href="#input-and-output-sequences" id="toc-input-and-output-sequences" class="nav-link" data-scroll-target="#input-and-output-sequences">Input and output sequences</a></li>
  <li><a href="#input-and-output-sequences-1" id="toc-input-and-output-sequences-1" class="nav-link" data-scroll-target="#input-and-output-sequences-1">Input and output sequences</a></li>
  <li><a href="#input-and-output-sequences-2" id="toc-input-and-output-sequences-2" class="nav-link" data-scroll-target="#input-and-output-sequences-2">Input and output sequences</a></li>
  <li><a href="#recurrent-layers-can-be-stacked." id="toc-recurrent-layers-can-be-stacked." class="nav-link" data-scroll-target="#recurrent-layers-can-be-stacked.">Recurrent layers can be stacked.</a></li>
  
  
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="rnns-and-time-series.slides.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Module 5</a></li><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Recurrent Neural Networks</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Recurrent Neural Networks</h1>
<p class="subtitle lead">ACTL3143 &amp; ACTL5111 Deep Learning for Actuaries</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Patrick Laub </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div id="3f5b2850" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the package imports</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, Input</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.callbacks <span class="im">import</span> EarlyStopping</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="time-series" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="time-series">Time Series</h2>
<section id="tabular-data-vs-time-series-data" class="level3">
<h3 class="anchored" data-anchor-id="tabular-data-vs-time-series-data">Tabular data vs time series data</h3>
<div class="columns">
<div class="column">
<p><strong>Tabular data</strong></p>
<p>We have a dataset <span class="math inline">\{ \boldsymbol{x}_i, y_i \}_{i=1}^n</span> which we assume are i.i.d. observations.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Brand</th>
<th style="text-align: center;">Mileage</th>
<th style="text-align: center;"># Claims</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">BMW</td>
<td style="text-align: center;">101 km</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Audi</td>
<td style="text-align: center;">432 km</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Volvo</td>
<td style="text-align: center;">3 km</td>
<td style="text-align: center;">5</td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\vdots</span></td>
<td style="text-align: center;"><span class="math inline">\vdots</span></td>
<td style="text-align: center;"><span class="math inline">\vdots</span></td>
</tr>
</tbody>
</table>
<p>The goal is to <em>predict</em> the <span class="math inline">y</span> for some covariates <span class="math inline">\boldsymbol{x}</span>.</p>
</div><div class="column">
<p><strong>Time series data</strong></p>
<p>Have a sequence <span class="math inline">\{ \boldsymbol{x}_t, y_t \}_{t=1}^T</span> of observations taken at regular time intervals.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">Date</th>
<th style="text-align: center;">Humidity</th>
<th style="text-align: center;">Temp.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Jan 1</td>
<td style="text-align: center;">60%</td>
<td style="text-align: center;">20 °C</td>
</tr>
<tr class="even">
<td style="text-align: center;">Jan 2</td>
<td style="text-align: center;">65%</td>
<td style="text-align: center;">22 °C</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Jan 3</td>
<td style="text-align: center;">70%</td>
<td style="text-align: center;">21 °C</td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\vdots</span></td>
<td style="text-align: center;"><span class="math inline">\vdots</span></td>
<td style="text-align: center;"><span class="math inline">\vdots</span></td>
</tr>
</tbody>
</table>
<p>The task is to <em>forecast</em> future values based on the past.</p>
</div>
</div>
</section>
<section id="attributes-of-time-series-data" class="level3">
<h3 class="anchored" data-anchor-id="attributes-of-time-series-data">Attributes of time series data</h3>
<ul>
<li><strong>Temporal ordering</strong>: The order of the observations matters.</li>
<li><strong>Trend</strong>: The general direction of the data.</li>
<li><strong>Noise</strong>: Random fluctuations in the data.</li>
<li><strong>Seasonality</strong>: Patterns that repeat at regular intervals.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Question: What will be the temperature in Berlin tomorrow? What information would you use to make a prediction?</p>
</div>
</div>
</section>
<section id="australian-financial-stocks" class="level3">
<h3 class="anchored" data-anchor-id="australian-financial-stocks">Australian financial stocks</h3>
<div id="ed4a62a4" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> pd.read_csv(<span class="st">"aus_fin_stocks.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>stocks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">ANZ</th>
<th data-quarto-table-cell-role="th">ASX200</th>
<th data-quarto-table-cell-role="th">BOQ</th>
<th data-quarto-table-cell-role="th">CBA</th>
<th data-quarto-table-cell-role="th">NAB</th>
<th data-quarto-table-cell-role="th">QBE</th>
<th data-quarto-table-cell-role="th">SUN</th>
<th data-quarto-table-cell-role="th">WBC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1981-01-02</td>
<td>1.588896</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1.791642</td>
<td>NaN</td>
<td>NaN</td>
<td>2.199454</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1981-01-05</td>
<td>1.548452</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1.791642</td>
<td>NaN</td>
<td>NaN</td>
<td>2.163397</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1981-01-06</td>
<td>1.600452</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1.791642</td>
<td>NaN</td>
<td>NaN</td>
<td>2.199454</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10327</td>
<td>2021-10-28</td>
<td>28.600000</td>
<td>7430.4</td>
<td>8.97</td>
<td>106.86</td>
<td>29.450000</td>
<td>12.10</td>
<td>12.02</td>
<td>26.230000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10328</td>
<td>2021-10-29</td>
<td>28.140000</td>
<td>7323.7</td>
<td>8.80</td>
<td>104.68</td>
<td>28.710000</td>
<td>11.83</td>
<td>11.72</td>
<td>25.670000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10329</td>
<td>2021-11-01</td>
<td>27.900000</td>
<td>7357.4</td>
<td>8.79</td>
<td>105.71</td>
<td>28.565000</td>
<td>12.03</td>
<td>11.83</td>
<td>24.050000</td>
</tr>
</tbody>
</table>

<p>10330 rows × 9 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="plot" class="level3">
<h3 class="anchored" data-anchor-id="plot">Plot</h3>
<div id="333cc671" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>stocks.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-types-and-na-values" class="level3">
<h3 class="anchored" data-anchor-id="data-types-and-na-values">Data types and NA values</h3>
<div class="columns">
<div class="column">
<div id="2a1f38e7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>stocks.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 10330 entries, 0 to 10329
Data columns (total 9 columns):
 #   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
 0   Date    10330 non-null  object 
 1   ANZ     10319 non-null  float64
 2   ASX200  7452 non-null   float64
 3   BOQ     8970 non-null   float64
 4   CBA     7624 non-null   float64
 5   NAB     10316 non-null  float64
 6   QBE     9441 non-null   float64
 7   SUN     8424 non-null   float64
 8   WBC     10323 non-null  float64
dtypes: float64(8), object(1)
memory usage: 726.5+ KB</code></pre>
</div>
</div>
</div><div class="column">
<div id="3aa8cd0d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> stocks.columns:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>stocks[col]<span class="sc">.</span>isna()<span class="sc">.</span>sum()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Date: 0
ANZ: 11
ASX200: 2878
BOQ: 1360
CBA: 2706
NAB: 14
QBE: 889
SUN: 1906
WBC: 7</code></pre>
</div>
</div>
</div>
</div>
<div id="3a69afdc" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>asx200 <span class="op">=</span> stocks.pop(<span class="st">"ASX200"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-the-index-to-the-date" class="level3">
<h3 class="anchored" data-anchor-id="set-the-index-to-the-date">Set the index to the date</h3>
<div id="a2d99d76" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>stocks[<span class="st">"Date"</span>] <span class="op">=</span> pd.to_datetime(stocks[<span class="st">"Date"</span>])</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> stocks.set_index(<span class="st">"Date"</span>) <span class="co"># or `stocks.set_index("Date", inplace=True)`</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>stocks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ANZ</th>
<th data-quarto-table-cell-role="th">BOQ</th>
<th data-quarto-table-cell-role="th">CBA</th>
<th data-quarto-table-cell-role="th">NAB</th>
<th data-quarto-table-cell-role="th">QBE</th>
<th data-quarto-table-cell-role="th">SUN</th>
<th data-quarto-table-cell-role="th">WBC</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981-01-02</td>
<td>1.588896</td>
<td>NaN</td>
<td>NaN</td>
<td>1.791642</td>
<td>NaN</td>
<td>NaN</td>
<td>2.199454</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1981-01-05</td>
<td>1.548452</td>
<td>NaN</td>
<td>NaN</td>
<td>1.791642</td>
<td>NaN</td>
<td>NaN</td>
<td>2.163397</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981-01-06</td>
<td>1.600452</td>
<td>NaN</td>
<td>NaN</td>
<td>1.791642</td>
<td>NaN</td>
<td>NaN</td>
<td>2.199454</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-10-28</td>
<td>28.600000</td>
<td>8.97</td>
<td>106.86</td>
<td>29.450000</td>
<td>12.10</td>
<td>12.02</td>
<td>26.230000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2021-10-29</td>
<td>28.140000</td>
<td>8.80</td>
<td>104.68</td>
<td>28.710000</td>
<td>11.83</td>
<td>11.72</td>
<td>25.670000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-11-01</td>
<td>27.900000</td>
<td>8.79</td>
<td>105.71</td>
<td>28.565000</td>
<td>12.03</td>
<td>11.83</td>
<td>24.050000</td>
</tr>
</tbody>
</table>

<p>10330 rows × 7 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="plot-ii" class="level3">
<h3 class="anchored" data-anchor-id="plot-ii">Plot II</h3>
<div id="bffae201" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>stocks.plot()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"upper center"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="op">-</span><span class="fl">0.5</span>), ncol<span class="op">=</span><span class="dv">4</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="can-index-using-dates-i" class="level3">
<h3 class="anchored" data-anchor-id="can-index-using-dates-i">Can index using dates I</h3>
<div id="0a47aa0e" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>stocks.loc[<span class="st">"2010-1-4"</span>:<span class="st">"2010-01-8"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ANZ</th>
<th data-quarto-table-cell-role="th">BOQ</th>
<th data-quarto-table-cell-role="th">CBA</th>
<th data-quarto-table-cell-role="th">NAB</th>
<th data-quarto-table-cell-role="th">QBE</th>
<th data-quarto-table-cell-role="th">SUN</th>
<th data-quarto-table-cell-role="th">WBC</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-01-04</td>
<td>22.89</td>
<td>10.772147</td>
<td>54.573702</td>
<td>26.046571</td>
<td>25.21</td>
<td>8.142453</td>
<td>25.012620</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2010-01-05</td>
<td>23.00</td>
<td>10.910369</td>
<td>55.399220</td>
<td>26.379283</td>
<td>25.34</td>
<td>8.264684</td>
<td>25.220235</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-01-06</td>
<td>22.66</td>
<td>10.855080</td>
<td>55.677708</td>
<td>25.865956</td>
<td>24.95</td>
<td>8.086039</td>
<td>25.101598</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2010-01-07</td>
<td>22.12</td>
<td>10.523346</td>
<td>55.140624</td>
<td>25.656823</td>
<td>24.50</td>
<td>8.198867</td>
<td>24.765460</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2010-01-08</td>
<td>22.25</td>
<td>10.781361</td>
<td>55.856736</td>
<td>25.571269</td>
<td>24.77</td>
<td>8.245879</td>
<td>24.864324</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Note, these ranges are <em>inclusive</em>, not like Python’s normal slicing.</p>
</section>
<section id="can-index-using-dates-ii" class="level3">
<h3 class="anchored" data-anchor-id="can-index-using-dates-ii">Can index using dates II</h3>
<p>So to get 2019’s December and all of 2020 for CBA:</p>
<div id="dbb4cc2a" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>stocks.loc[<span class="st">"2019-12"</span>:<span class="st">"2020"</span>, [<span class="st">"CBA"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CBA</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-12-02</td>
<td>81.43</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-12-03</td>
<td>79.34</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-12-04</td>
<td>77.81</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2020-12-29</td>
<td>84.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2020-12-30</td>
<td>83.59</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2020-12-31</td>
<td>82.11</td>
</tr>
</tbody>
</table>

<p>275 rows × 1 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="can-look-at-the-first-differences" class="level3">
<h3 class="anchored" data-anchor-id="can-look-at-the-first-differences">Can look at the first differences</h3>
<div id="f8a075ae" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>stocks.diff().plot()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"upper center"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="op">-</span><span class="fl">0.5</span>), ncol<span class="op">=</span><span class="dv">4</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="can-look-at-the-percentage-changes" class="level3">
<h3 class="anchored" data-anchor-id="can-look-at-the-percentage-changes">Can look at the percentage changes</h3>
<div id="7b5978f1" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>stocks.pct_change().plot()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"upper center"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="op">-</span><span class="fl">0.5</span>), ncol<span class="op">=</span><span class="dv">4</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/sq/__n07d014s3gvhj5fy8b61zr0000gn/T/ipykernel_33460/1668655876.py:1: FutureWarning: The default fill_method='pad' in DataFrame.pct_change is deprecated and will be removed in a future version. Either fill in any non-leading NA values prior to calling pct_change or specify 'fill_method=None' to not fill NA values.
  stocks.pct_change().plot()</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="focus-on-one-stock" class="level3">
<h3 class="anchored" data-anchor-id="focus-on-one-stock">Focus on one stock</h3>
<div class="columns">
<div class="column">
<div id="a480597a" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>stock <span class="op">=</span> stocks[[<span class="st">"CBA"</span>]]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>stock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CBA</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981-01-02</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1981-01-05</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981-01-06</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-10-28</td>
<td>106.86</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2021-10-29</td>
<td>104.68</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-11-01</td>
<td>105.71</td>
</tr>
</tbody>
</table>

<p>10330 rows × 1 columns</p>
</div>
</div>
</div>
</div>
</div><div class="column">
<div id="917d3b11" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>stock.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Find first non-missing value</p>
<div id="abcabccb" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>first_day <span class="op">=</span> stock.dropna().index[<span class="dv">0</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>first_day</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Timestamp('1991-09-12 00:00:00')</code></pre>
</div>
</div>
<div id="06c45411" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>stock <span class="op">=</span> stock.loc[first_day:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ac7125b7" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>stock.isna().sum()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>CBA    8
dtype: int64</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="fill-in-the-missing-values" class="level3">
<h3 class="anchored" data-anchor-id="fill-in-the-missing-values">Fill in the missing values</h3>
<div id="fe798377" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>missing_day <span class="op">=</span> stock[stock[<span class="st">"CBA"</span>].isna()].index[<span class="dv">0</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>prev_day <span class="op">=</span> missing_day <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>after <span class="op">=</span> missing_day <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="columns">
<div class="column">
<div id="4941bd06" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>stock.loc[prev_day:after]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CBA</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-03-07</td>
<td>24.56662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-03-08</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-03-09</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-03-10</td>
<td>22.87580</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div><div class="column">
<div id="7e022e76" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>stock <span class="op">=</span> stock.ffill()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>stock.loc[prev_day:after]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CBA</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-03-07</td>
<td>24.56662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-03-08</td>
<td>24.56662</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-03-09</td>
<td>24.56662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-03-10</td>
<td>22.87580</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
</div>
<div id="61daf29f" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>stock.isna().sum()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>CBA    0
dtype: int64</code></pre>
</div>
</div>
</section>
</section>
<section id="baseline-forecasts" class="level2">
<h2 class="anchored" data-anchor-id="baseline-forecasts">Baseline forecasts</h2>
<section id="persistence-forecast" class="level3">
<h3 class="anchored" data-anchor-id="persistence-forecast">Persistence forecast</h3>
<p>The simplest model is to predict the next value to be the same as the current value.</p>
<div id="f1efd9a8" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2019"</span>:, <span class="st">"Persistence"</span>] <span class="op">=</span> stock.loc[<span class="st">"2018"</span>].iloc[<span class="op">-</span><span class="dv">1</span>].values[<span class="dv">0</span>]</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].plot()</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="trend" class="level3">
<h3 class="anchored" data-anchor-id="trend">Trend</h3>
<p>We can extrapolate from recent trend:</p>
<div id="77044adb" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>past_date <span class="op">=</span> stock.loc[<span class="st">"2018"</span>].index[<span class="op">-</span><span class="dv">30</span>]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>past <span class="op">=</span> stock.loc[past_date, <span class="st">"CBA"</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>latest_date <span class="op">=</span> stock.loc[<span class="st">"2018"</span>, <span class="st">"CBA"</span>].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> stock.loc[latest_date, <span class="st">"CBA"</span>]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>trend <span class="op">=</span> (latest <span class="op">-</span> past) <span class="op">/</span> (latest_date <span class="op">-</span> past_date).days</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(trend)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>tdays_since_cutoff <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="bu">len</span>(stock.loc[<span class="st">"2019"</span>:]) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2019"</span>:, <span class="st">"Trend"</span>] <span class="op">=</span> latest <span class="op">+</span> trend <span class="op">*</span> tdays_since_cutoff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.07755555555555545</code></pre>
</div>
</div>
</section>
<section id="trend-forecasts" class="level3">
<h3 class="anchored" data-anchor-id="trend-forecasts">Trend forecasts</h3>
<div id="e1856faf" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].plot()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>plt.legend(ncol<span class="op">=</span><span class="dv">3</span>, loc<span class="op">=</span><span class="st">"upper center"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="fl">1.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="which-is-better" class="level3">
<h3 class="anchored" data-anchor-id="which-is-better">Which is better?</h3>
<p>If we look at the mean squared error (MSE) of the two models:</p>
<div id="eaa8b34e" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>persistence_mse <span class="op">=</span> mean_squared_error(stock.loc[<span class="st">"2019"</span>, <span class="st">"CBA"</span>], stock.loc[<span class="st">"2019"</span>, <span class="st">"Persistence"</span>])</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>trend_mse <span class="op">=</span> mean_squared_error(stock.loc[<span class="st">"2019"</span>, <span class="st">"CBA"</span>], stock.loc[<span class="st">"2019"</span>, <span class="st">"Trend"</span>])</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>(39.54629367588932, 37.87104674064297)</code></pre>
</div>
</div>
</section>
<section id="use-the-history" class="level3">
<h3 class="anchored" data-anchor-id="use-the-history">Use the history</h3>
<div id="b6edc17b" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cba_shifted <span class="op">=</span> stock[<span class="st">"CBA"</span>].head().shift(<span class="dv">1</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>both <span class="op">=</span> pd.concat([stock[<span class="st">"CBA"</span>].head(), cba_shifted], axis<span class="op">=</span><span class="dv">1</span>, keys<span class="op">=</span>[<span class="st">"Today"</span>, <span class="st">"Yesterday"</span>])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>both</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Today</th>
<th data-quarto-table-cell-role="th">Yesterday</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-09-12</td>
<td>6.425116</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1991-09-13</td>
<td>6.365440</td>
<td>6.425116</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-09-16</td>
<td>6.305764</td>
<td>6.365440</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1991-09-17</td>
<td>6.285872</td>
<td>6.305764</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-09-18</td>
<td>6.325656</td>
<td>6.285872</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="a1f77db8" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lagged_timeseries(df, target, window<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    lagged <span class="op">=</span> pd.DataFrame()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(window, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        lagged[<span class="ss">f"T-</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> df[target].shift(i)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    lagged[<span class="st">"T"</span>] <span class="op">=</span> df[target].values</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lagged</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="lagged-time-series" class="level3">
<h3 class="anchored" data-anchor-id="lagged-time-series">Lagged time series</h3>
<div id="d95a4f0e" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_lags <span class="op">=</span> lagged_timeseries(stock, <span class="st">"CBA"</span>, <span class="dv">40</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>df_lags</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">T-40</th>
<th data-quarto-table-cell-role="th">T-39</th>
<th data-quarto-table-cell-role="th">T-38</th>
<th data-quarto-table-cell-role="th">T-37</th>
<th data-quarto-table-cell-role="th">T-36</th>
<th data-quarto-table-cell-role="th">T-35</th>
<th data-quarto-table-cell-role="th">T-34</th>
<th data-quarto-table-cell-role="th">T-33</th>
<th data-quarto-table-cell-role="th">T-32</th>
<th data-quarto-table-cell-role="th">T-31</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">T-9</th>
<th data-quarto-table-cell-role="th">T-8</th>
<th data-quarto-table-cell-role="th">T-7</th>
<th data-quarto-table-cell-role="th">T-6</th>
<th data-quarto-table-cell-role="th">T-5</th>
<th data-quarto-table-cell-role="th">T-4</th>
<th data-quarto-table-cell-role="th">T-3</th>
<th data-quarto-table-cell-role="th">T-2</th>
<th data-quarto-table-cell-role="th">T-1</th>
<th data-quarto-table-cell-role="th">T</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-09-12</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>6.425116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1991-09-13</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>6.425116</td>
<td>6.365440</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-09-16</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>6.425116</td>
<td>6.365440</td>
<td>6.305764</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-10-28</td>
<td>101.37</td>
<td>101.84</td>
<td>102.16</td>
<td>102.14</td>
<td>102.92</td>
<td>100.55</td>
<td>101.09</td>
<td>101.30</td>
<td>101.58</td>
<td>101.41</td>
<td>...</td>
<td>102.28</td>
<td>103.94</td>
<td>103.89</td>
<td>105.03</td>
<td>104.95</td>
<td>104.88</td>
<td>105.46</td>
<td>105.100000</td>
<td>106.100000</td>
<td>106.860000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2021-10-29</td>
<td>101.84</td>
<td>102.16</td>
<td>102.14</td>
<td>102.92</td>
<td>100.55</td>
<td>101.09</td>
<td>101.30</td>
<td>101.58</td>
<td>101.41</td>
<td>102.85</td>
<td>...</td>
<td>103.94</td>
<td>103.89</td>
<td>105.03</td>
<td>104.95</td>
<td>104.88</td>
<td>105.46</td>
<td>105.10</td>
<td>106.100000</td>
<td>106.860000</td>
<td>104.680000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-11-01</td>
<td>102.16</td>
<td>102.14</td>
<td>102.92</td>
<td>100.55</td>
<td>101.09</td>
<td>101.30</td>
<td>101.58</td>
<td>101.41</td>
<td>102.85</td>
<td>102.88</td>
<td>...</td>
<td>103.89</td>
<td>105.03</td>
<td>104.95</td>
<td>104.88</td>
<td>105.46</td>
<td>105.10</td>
<td>106.10</td>
<td>106.860000</td>
<td>104.680000</td>
<td>105.710000</td>
</tr>
</tbody>
</table>

<p>7632 rows × 41 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="split-into-training-and-testing" class="level3">
<h3 class="anchored" data-anchor-id="split-into-training-and-testing">Split into training and testing</h3>
<div id="83162525" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the data in time</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> df_lags.loc[:<span class="st">"2018"</span>]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> df_lags.loc[<span class="st">"2019"</span>]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> df_lags.loc[<span class="st">"2020"</span>:]</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any with NAs and split into X and y</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X_train.dropna()</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> X_val.dropna()</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X_test.dropna()</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> X_train.pop(<span class="st">"T"</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> X_val.pop(<span class="st">"T"</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> X_test.pop(<span class="st">"T"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e31a92de" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>X_train.shape, y_train.shape, X_val.shape, y_val.shape, X_test.shape, y_test.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>((6872, 40), (6872,), (253, 40), (253,), (467, 40), (467,))</code></pre>
</div>
</div>
</section>
<section id="inspect-the-split-data" class="level3">
<h3 class="anchored" data-anchor-id="inspect-the-split-data">Inspect the split data</h3>
<div id="72f36103" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>X_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">T-40</th>
<th data-quarto-table-cell-role="th">T-39</th>
<th data-quarto-table-cell-role="th">T-38</th>
<th data-quarto-table-cell-role="th">T-37</th>
<th data-quarto-table-cell-role="th">T-36</th>
<th data-quarto-table-cell-role="th">T-35</th>
<th data-quarto-table-cell-role="th">T-34</th>
<th data-quarto-table-cell-role="th">T-33</th>
<th data-quarto-table-cell-role="th">T-32</th>
<th data-quarto-table-cell-role="th">T-31</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">T-10</th>
<th data-quarto-table-cell-role="th">T-9</th>
<th data-quarto-table-cell-role="th">T-8</th>
<th data-quarto-table-cell-role="th">T-7</th>
<th data-quarto-table-cell-role="th">T-6</th>
<th data-quarto-table-cell-role="th">T-5</th>
<th data-quarto-table-cell-role="th">T-4</th>
<th data-quarto-table-cell-role="th">T-3</th>
<th data-quarto-table-cell-role="th">T-2</th>
<th data-quarto-table-cell-role="th">T-1</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-11-07</td>
<td>6.425116</td>
<td>6.365440</td>
<td>6.305764</td>
<td>6.285872</td>
<td>6.325656</td>
<td>6.385332</td>
<td>6.445008</td>
<td>6.445008</td>
<td>6.504684</td>
<td>6.564360</td>
<td>...</td>
<td>7.280472</td>
<td>7.260580</td>
<td>7.190958</td>
<td>7.240688</td>
<td>7.379932</td>
<td>7.459500</td>
<td>7.320256</td>
<td>7.360040</td>
<td>7.459500</td>
<td>7.379932</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1991-11-08</td>
<td>6.365440</td>
<td>6.305764</td>
<td>6.285872</td>
<td>6.325656</td>
<td>6.385332</td>
<td>6.445008</td>
<td>6.445008</td>
<td>6.504684</td>
<td>6.564360</td>
<td>6.624036</td>
<td>...</td>
<td>7.260580</td>
<td>7.190958</td>
<td>7.240688</td>
<td>7.379932</td>
<td>7.459500</td>
<td>7.320256</td>
<td>7.360040</td>
<td>7.459500</td>
<td>7.379932</td>
<td>7.379932</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1991-11-11</td>
<td>6.305764</td>
<td>6.285872</td>
<td>6.325656</td>
<td>6.385332</td>
<td>6.445008</td>
<td>6.445008</td>
<td>6.504684</td>
<td>6.564360</td>
<td>6.624036</td>
<td>6.663820</td>
<td>...</td>
<td>7.190958</td>
<td>7.240688</td>
<td>7.379932</td>
<td>7.459500</td>
<td>7.320256</td>
<td>7.360040</td>
<td>7.459500</td>
<td>7.379932</td>
<td>7.379932</td>
<td>7.449554</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2018-12-27</td>
<td>68.160000</td>
<td>69.230000</td>
<td>68.940000</td>
<td>68.350000</td>
<td>67.980000</td>
<td>68.950000</td>
<td>69.350000</td>
<td>70.620000</td>
<td>70.950000</td>
<td>71.770000</td>
<td>...</td>
<td>68.430000</td>
<td>70.080000</td>
<td>70.180000</td>
<td>68.810000</td>
<td>69.260000</td>
<td>68.600000</td>
<td>69.400000</td>
<td>68.920000</td>
<td>68.480000</td>
<td>68.650000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2018-12-28</td>
<td>69.230000</td>
<td>68.940000</td>
<td>68.350000</td>
<td>67.980000</td>
<td>68.950000</td>
<td>69.350000</td>
<td>70.620000</td>
<td>70.950000</td>
<td>71.770000</td>
<td>70.900000</td>
<td>...</td>
<td>70.080000</td>
<td>70.180000</td>
<td>68.810000</td>
<td>69.260000</td>
<td>68.600000</td>
<td>69.400000</td>
<td>68.920000</td>
<td>68.480000</td>
<td>68.650000</td>
<td>70.330000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2018-12-31</td>
<td>68.940000</td>
<td>68.350000</td>
<td>67.980000</td>
<td>68.950000</td>
<td>69.350000</td>
<td>70.620000</td>
<td>70.950000</td>
<td>71.770000</td>
<td>70.900000</td>
<td>69.210000</td>
<td>...</td>
<td>70.180000</td>
<td>68.810000</td>
<td>69.260000</td>
<td>68.600000</td>
<td>69.400000</td>
<td>68.920000</td>
<td>68.480000</td>
<td>68.650000</td>
<td>70.330000</td>
<td>71.910000</td>
</tr>
</tbody>
</table>

<p>6872 rows × 40 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="plot-the-split" class="level3">
<h3 class="anchored" data-anchor-id="plot-the-split">Plot the split</h3>
<div id="67229225" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>y_train.plot()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>y_val.plot()</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>y_test.plot()</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"Validation"</span>, <span class="st">"Test"</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="train-on-more-recent-data" class="level3">
<h3 class="anchored" data-anchor-id="train-on-more-recent-data">Train on more recent data</h3>
<div id="c9d7bdc6" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X_train.loc[<span class="st">"2012"</span>:]</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y_train.loc[<span class="st">"2012"</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a0438771" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>y_train.plot()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>y_val.plot()</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>y_test.plot()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"Validation"</span>, <span class="st">"Test"</span>], loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="rescale-by-eyeballing-it" class="level3">
<h3 class="anchored" data-anchor-id="rescale-by-eyeballing-it">Rescale by eyeballing it</h3>
<div id="7be7db2b" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X_train <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> X_val <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X_test <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y_train <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> y_val <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y_test <span class="op">/</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="487c9a41" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>y_train.plot()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>y_val.plot()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>y_test.plot()</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Train"</span>, <span class="st">"Validation"</span>, <span class="st">"Test"</span>], loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fit-a-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="fit-a-linear-model">Fit a linear model</h3>
<div id="18548be0" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>lr.fit(X_train, y_train)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make a forecast for the validation data:</p>
<div id="dbf63bab" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> lr.predict(X_val)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>stock.loc[X_val.index, <span class="st">"Linear"</span>] <span class="op">=</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1706bed8" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].plot()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="inverse-transform-the-forecasts" class="level3">
<h3 class="anchored" data-anchor-id="inverse-transform-the-forecasts">Inverse-transform the forecasts</h3>
<div id="703a6a6b" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>stock.loc[X_val.index, <span class="st">"Linear"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="215d94e1" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].plot()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-43-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="careful-with-the-metrics" class="level3">
<h3 class="anchored" data-anchor-id="careful-with-the-metrics">Careful with the metrics</h3>
<div id="294aa391" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mean_squared_error(y_val, y_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>6.329105517812206e-05</code></pre>
</div>
</div>
<div id="911063ec" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>mean_squared_error(<span class="dv">100</span> <span class="op">*</span> y_val, <span class="dv">100</span> <span class="op">*</span> y_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>0.6329105517812207</code></pre>
</div>
</div>
<div id="a777c72e" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, y_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>0.6329105517812206</code></pre>
</div>
</div>
<div id="ee573914" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>linear_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, y_pred)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse, linear_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>(39.54629367588932, 37.87104674064297, 0.6329105517812206)</code></pre>
</div>
</div>
</section>
</section>
<section id="multi-step-forecasts" class="level2">
<h2 class="anchored" data-anchor-id="multi-step-forecasts">Multi-step forecasts</h2>
<section id="comparing-apples-to-apples" class="level3 smaller">
<h3 class="smaller anchored" data-anchor-id="comparing-apples-to-apples">Comparing apples to apples</h3>
<p>The linear model is only producing <em>one-step-ahead</em> forecasts.</p>
<p>The other models are producing <em>multi-step-ahead</em> forecasts.</p>
<div id="e09a83b2" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2019"</span>:, <span class="st">"Shifted"</span>] <span class="op">=</span> stock[<span class="st">"CBA"</span>].shift(<span class="dv">1</span>).loc[<span class="st">"2019"</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="091b14de" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].plot()</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8e43cadf" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>shifted_mse <span class="op">=</span> mean_squared_error(stock.loc[<span class="st">"2019"</span>, <span class="st">"CBA"</span>], stock.loc[<span class="st">"2019"</span>, <span class="st">"Shifted"</span>])</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse, linear_mse, shifted_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>(39.54629367588932, 37.87104674064297, 0.6329105517812206, 0.6367221343873524)</code></pre>
</div>
</div>
</section>
<section id="autoregressive-forecasts" class="level3">
<h3 class="anchored" data-anchor-id="autoregressive-forecasts">Autoregressive forecasts</h3>
<p>The linear model needs the last 90 days to make a forecast.</p>
<p><strong>Idea</strong>: Make the first forecast, then use that to make the next forecast, and so on.</p>
<p><span class="math display">
\begin{aligned}
    \hat{y}_t &amp;= \beta_0 + \beta_1 y_{t-1} + \beta_2 y_{t-2} + \ldots + \beta_n y_{t-n} \\
    \hat{y}_{t+1} &amp;= \beta_0 + \beta_1 \hat{y}_t + \beta_2 y_{t-1} + \ldots + \beta_n y_{t-n+1} \\
    \hat{y}_{t+2} &amp;= \beta_0 + \beta_1 \hat{y}_{t+1} + \beta_2 \hat{y}_t + \ldots + \beta_n y_{t-n+2}
\end{aligned}
</span> <span class="math display">\vdots</span> <span class="math display">
\hat{y}_{t+k} = \beta_0 + \beta_1 \hat{y}_{t+k-1} + \beta_2 \hat{y}_{t+k-2} + \ldots + \beta_n \hat{y}_{t+k-n}
</span></p>
</section>
<section id="autoregressive-forecasting-function" class="level3">
<h3 class="anchored" data-anchor-id="autoregressive-forecasting-function">Autoregressive forecasting function</h3>
<div id="61ce204d" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> autoregressive_forecast(model, X_val, suppress<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate a multi-step forecast using the given model.</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    multi_step <span class="op">=</span> pd.Series(index<span class="op">=</span>X_val.index, name<span class="op">=</span><span class="st">"Multi Step"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the input data for forecasting</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> X_val.iloc[<span class="dv">0</span>].values.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(multi_step)):</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure input_data has the correct feature names</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>        input_df <span class="op">=</span> pd.DataFrame(input_data, columns<span class="op">=</span>X_val.columns)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> suppress:</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>            next_value <span class="op">=</span> model.predict(input_df, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>            next_value <span class="op">=</span> model.predict(input_df) </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        multi_step.iloc[i] <span class="op">=</span> next_value</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append that prediction to the input for the next forecast</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">+</span> <span class="dv">1</span> <span class="op">&lt;</span> <span class="bu">len</span>(multi_step):</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>            input_data <span class="op">=</span> np.append(input_data[:, <span class="dv">1</span>:], next_value).reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> multi_step</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="look-at-the-autoregressive-linear-forecasts" class="level3">
<h3 class="anchored" data-anchor-id="look-at-the-autoregressive-linear-forecasts">Look at the autoregressive linear forecasts</h3>
<div id="1053b291" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>lr_forecast <span class="op">=</span> autoregressive_forecast(lr, X_val)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>stock.loc[lr_forecast.index, <span class="st">"MS Linear"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> lr_forecast</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="94d1f947" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Linear"</span>, <span class="st">"Shifted"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-53-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metrics" class="level3">
<h3 class="anchored" data-anchor-id="metrics">Metrics</h3>
<p>One-step-ahead forecasts:</p>
<div id="755f393c" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>linear_mse, shifted_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(0.6329105517812206, 0.6367221343873524)</code></pre>
</div>
</div>
<p>Multi-step-ahead forecasts:</p>
<div id="4cb9328f" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>multi_step_linear_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, lr_forecast)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse, multi_step_linear_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>(39.54629367588932, 37.87104674064297, 23.84700379112976)</code></pre>
</div>
</div>
</section>
<section id="prefer-only-short-windows" class="level3">
<h3 class="anchored" data-anchor-id="prefer-only-short-windows">Prefer only short windows</h3>
<div id="9b204aba" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2019"</span>:<span class="st">"2019-1"</span>].drop([<span class="st">"Linear"</span>, <span class="st">"Shifted"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()<span class="op">;</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-56-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>“It’s tough to make predictions, especially about the future.”</p>
</blockquote>
<div class="footer">
<p>Yogi Berra</p>
</div>
</section>
</section>
<section id="neural-network-forecasts" class="level2">
<h2 class="anchored" data-anchor-id="neural-network-forecasts">Neural network forecasts</h2>
<section id="simple-feedforward-neural-network" class="level3">
<h3 class="anchored" data-anchor-id="simple-feedforward-neural-network">Simple feedforward neural network</h3>
<div id="e517fbb9" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"leaky_relu"</span>),</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">1</span>, <span class="st">"softplus"</span>)])</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>model.compile(optimizer<span class="op">=</span><span class="st">"adam"</span>, loss<span class="op">=</span><span class="st">"mean_squared_error"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="79593d5b" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> Path(<span class="st">"aus_fin_fnn_model.h5"</span>).exists():</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> keras.models.load_model(<span class="st">"aus_fin_fnn_model.h5"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">15</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train, validation_data<span class="op">=</span>(X_val, y_val), epochs<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>        callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    model.save(<span class="st">"aus_fin_fnn_model.h5"</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential"</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ dense (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                   │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)               │         <span style="color: #00af00; text-decoration-color: #00af00">2,624</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                │            <span style="color: #00af00; text-decoration-color: #00af00">65</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">2,691</span> (10.51 KB)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">2,689</span> (10.50 KB)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">2</span> (8.00 B)
</pre>
</div>
</div>
</section>
<section id="forecast-and-plot" class="level3">
<h3 class="anchored" data-anchor-id="forecast-and-plot">Forecast and plot</h3>
<div id="437ef7e6" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_val, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>stock.loc[X_val.index, <span class="st">"FNN"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3499f8d6" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Persistence"</span>, <span class="st">"Trend"</span>, <span class="st">"MS Linear"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-60-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="autoregressive-forecasts-1" class="level3">
<h3 class="anchored" data-anchor-id="autoregressive-forecasts-1">Autoregressive forecasts</h3>
<div id="41ae34d5" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>nn_forecast <span class="op">=</span> autoregressive_forecast(model, X_val, <span class="va">True</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>stock.loc[nn_forecast.index, <span class="st">"MS FNN"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> nn_forecast</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f0dca86b" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Linear"</span>, <span class="st">"Shifted"</span>, <span class="st">"FNN"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metrics-1" class="level3">
<h3 class="anchored" data-anchor-id="metrics-1">Metrics</h3>
<p>One-step-ahead forecasts:</p>
<div id="ed16bbb0" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>nn_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, y_pred)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>linear_mse, shifted_mse, nn_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>(0.6329105517812206, 0.6367221343873524, 1.0445119512080592)</code></pre>
</div>
</div>
<p>Multi-step-ahead forecasts:</p>
<div id="1135b2b7" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>multi_step_fnn_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, nn_forecast)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse, multi_step_linear_mse, multi_step_fnn_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>(39.54629367588932, 37.87104674064297, 23.84700379112976, 10.15084682208212)</code></pre>
</div>
</div>
</section>
</section>
<section id="recurrent-neural-networks" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="recurrent-neural-networks">Recurrent Neural Networks</h2>
<section id="basic-facts-of-rnns" class="level3">
<h3 class="anchored" data-anchor-id="basic-facts-of-rnns">Basic facts of RNNs</h3>
<ul>
<li>A recurrent neural network is a type of neural network that is designed to process sequences of data (e.g.&nbsp;time series, sentences).</li>
<li>A recurrent neural network is any network that contains a recurrent layer.</li>
<li>A recurrent layer is a layer that processes data in a sequence.</li>
<li>An RNN can have one or more recurrent layers.</li>
<li>Weights are shared over time; this allows the model to be used on arbitrary-length sequences.</li>
</ul>
</section>
<section id="applications" class="level3">
<h3 class="anchored" data-anchor-id="applications">Applications</h3>
<ul>
<li>Forecasting: revenue forecast, weather forecast, predict disease rate from medical history, etc.</li>
<li>Classification: given a time series of the activities of a visitor on a website, classify whether the visitor is a bot or a human.</li>
<li>Event detection: given a continuous data stream, identify the occurrence of a specific event. Example: Detect utterances like “Hey Alexa” from an audio stream.</li>
<li>Anomaly detection: given a continuous data stream, detect anything unusual happening. Example: Detect unusual activity on the corporate network.</li>
</ul>
</section>
<section id="origin-of-the-name-of-rnns" class="level3">
<h3 class="anchored" data-anchor-id="origin-of-the-name-of-rnns">Origin of the name of RNNs</h3>
<blockquote class="blockquote">
<p>A recurrence relation is an equation that expresses each element of a sequence as a function of the preceding ones. More precisely, in the case where only the immediately preceding element is involved, a recurrence relation has the form</p>
<p><span class="math display"> u_n = \psi(n, u_{n-1}) \quad \text{ for } \quad n &gt; 0.</span></p>
</blockquote>
<p><strong>Example</strong>: Factorial <span class="math inline">n! = n (n-1)!</span> for <span class="math inline">n &gt; 0</span> given <span class="math inline">0! = 1</span>.</p>
<div class="footer">
<p>Source: Wikipedia, <a href="https://en.wikipedia.org/wiki/Recurrence_relation#Definition">Recurrence relation</a>.</p>
</div>
</section>
<section id="diagram-of-an-rnn-cell" class="level3">
<h3 class="anchored" data-anchor-id="diagram-of-an-rnn-cell">Diagram of an RNN cell</h3>
<p>The RNN processes each data in the sequence one by one, while keeping memory of what came before.</p>
<p>The following figure shows how the recurrent neural network combines an input <code>X_l</code> with a preprocessed state of the process <code>A_l</code> to produce the output <code>O_l</code>. RNNs have a cyclic information processing structure that enables them to pass information sequentially from previous inputs. RNNs can capture dependencies and patterns in sequential data, making them useful for analysing time series data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ISLR2-10_12.svg" class="img-fluid figure-img"></p>
<figcaption>Schematic of a recurrent neural network. E.g. SimpleRNN, LSTM, or GRU.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: James et al (2022), <a href="https://www.statlearning.com/">An Introduction to Statistical Learning</a>, 2nd edition, Figure 10.12.</p>
</div>
</section>
<section id="a-simplernn-cell" class="level3">
<h3 class="anchored" data-anchor-id="a-simplernn-cell">A SimpleRNN cell</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="colah-LSTM3-SimpleRNN.png" class="img-fluid figure-img"></p>
<figcaption>Diagram of a SimpleRNN cell.</figcaption>
</figure>
</div>
<p>All the outputs before the final one are often discarded.</p>
<div class="footer">
<p>Source: Christopher Olah (2015), <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">Understanding LSTM Networks</a>, Colah’s Blog.</p>
</div>
</section>
<section id="lstm-internals" class="level3">
<h3 class="anchored" data-anchor-id="lstm-internals">LSTM internals</h3>
<p>Simple RNN structures encounter vanishing gradient problems, hence, struggle with learning long term dependencies. LSTM are designed to overcome this problem. LSTMs have a more complex network structure (contains more memory cells and gating mechanisms) and can better regulate the information flow.</p>
<p><img src="colah-LSTM3-chain.png" class="img-fluid" alt="Diagram of an LSTM cell."> <img src="colah-LSTM2-notation.png" class="img-fluid" alt="Notation for the diagram."></p>
<div class="footer">
<p>Source: Christopher Olah (2015), <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">Understanding LSTM Networks</a>, Colah’s Blog.</p>
</div>
</section>
<section id="gru-internals" class="level3">
<h3 class="anchored" data-anchor-id="gru-internals">GRU internals</h3>
<p>GRUs are simpler compared to LSTM, hence, computationally more efficient than LSTMs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="colah-LSTM3-var-GRU.png" class="img-fluid figure-img"></p>
<figcaption>Diagram of a GRU cell.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Christopher Olah (2015), <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">Understanding LSTM Networks</a>, Colah’s Blog.</p>
</div>
</section>
</section>
<section id="rnn-demo" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="rnn-demo">RNN Demo</h2>
<section id="simplernn" class="level3">
<h3 class="anchored" data-anchor-id="simplernn">SimpleRNN</h3>
<div id="929ad75a" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> SimpleRNN, Reshape</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>        Reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>        SimpleRNN(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">"tanh"</span>),</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">1</span>, <span class="st">"softplus"</span>)])</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>model.compile(optimizer<span class="op">=</span><span class="st">"adam"</span>, loss<span class="op">=</span><span class="st">"mean_squared_error"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3ccd4e4e" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">15</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train, validation_data<span class="op">=</span>(X_val, y_val),</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">500</span>, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b48f2beb" class="cell" data-execution_count="66">
<div class="cell-output cell-output-stderr">
<pre><code>/Users/plaub/miniconda3/envs/ai2024/lib/python3.11/site-packages/torch/utils/_device.py:78: UserWarning: The operator 'aten::linalg_qr.out' is not currently supported on the MPS backend and will fall back to run on the CPU. This may have performance implications. (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/aten/src/ATen/mps/MPSFallback.mm:13.)
  return func(*args, **kwargs)
WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential_1"</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ reshape (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)               │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">40</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)            │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ simple_rnn (<span style="color: #0087ff; text-decoration-color: #0087ff">SimpleRNN</span>)          │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)               │         <span style="color: #00af00; text-decoration-color: #00af00">4,224</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                │            <span style="color: #00af00; text-decoration-color: #00af00">65</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">4,291</span> (16.76 KB)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">4,289</span> (16.75 KB)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">2</span> (8.00 B)
</pre>
</div>
</div>
</section>
<section id="forecast-and-plot-1" class="level3">
<h3 class="anchored" data-anchor-id="forecast-and-plot-1">Forecast and plot</h3>
<div id="74c999d6" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_val.to_numpy(), verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>stock.loc[X_val.index, <span class="st">"SimpleRNN"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="83aa769f" class="cell" data-execution_count="68">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Persistence"</span>, <span class="st">"Trend"</span>, <span class="st">"MS Linear"</span>, <span class="st">"MS FNN"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-69-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multi-step-forecasts-1" class="level3">
<h3 class="anchored" data-anchor-id="multi-step-forecasts-1">Multi-step forecasts</h3>
<div id="e7322ed2" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>rnn_forecast <span class="op">=</span> autoregressive_forecast(model, X_val, <span class="va">True</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>stock.loc[rnn_forecast.index, <span class="st">"MS RNN"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> rnn_forecast</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5e691ee9" class="cell" data-execution_count="70">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Linear"</span>, <span class="st">"Shifted"</span>, <span class="st">"FNN"</span>, <span class="st">"SimpleRNN"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-71-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metrics-2" class="level3">
<h3 class="anchored" data-anchor-id="metrics-2">Metrics</h3>
<p>One-step-ahead forecasts:</p>
<div id="2a8f4890" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>rnn_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, y_pred)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>linear_mse, shifted_mse, nn_mse, rnn_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>(0.6329105517812206, 0.6367221343873524, 1.0445119512080592, 0.644451203191208)</code></pre>
</div>
</div>
<p>Multi-step-ahead forecasts:</p>
<div id="47670d63" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>multi_step_rnn_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, rnn_forecast)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse, multi_step_linear_mse, multi_step_fnn_mse, multi_step_rnn_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>(39.54629367588932,
 37.87104674064297,
 23.84700379112976,
 10.15084682208212,
 10.584407213912131)</code></pre>
</div>
</div>
</section>
<section id="gru" class="level3">
<h3 class="anchored" data-anchor-id="gru">GRU</h3>
<div id="4913d26d" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> GRU</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([Reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        GRU(<span class="dv">16</span>, activation<span class="op">=</span><span class="st">"tanh"</span>),</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">1</span>, <span class="st">"softplus"</span>)])</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>model.compile(optimizer<span class="op">=</span><span class="st">"adam"</span>, loss<span class="op">=</span><span class="st">"mean_squared_error"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="46f4012a" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">15</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train, validation_data<span class="op">=</span>(X_val, y_val),</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">500</span>, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="73b9871e" class="cell" data-execution_count="75">
<div class="cell-output cell-output-stderr">
<pre><code>WARNING:absl:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential_2"</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ reshape_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)             │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">40</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)            │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ gru (<span style="color: #0087ff; text-decoration-color: #0087ff">GRU</span>)                       │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">16</span>)               │           <span style="color: #00af00; text-decoration-color: #00af00">912</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                │            <span style="color: #00af00; text-decoration-color: #00af00">17</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">931</span> (3.64 KB)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">929</span> (3.63 KB)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">2</span> (8.00 B)
</pre>
</div>
</div>
</section>
<section id="forecast-and-plot-2" class="level3">
<h3 class="anchored" data-anchor-id="forecast-and-plot-2">Forecast and plot</h3>
<div id="7b708683" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_val, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>stock.loc[X_val.index, <span class="st">"GRU"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="88883e8f" class="cell" data-execution_count="77">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Persistence"</span>, <span class="st">"Trend"</span>, <span class="st">"MS Linear"</span>, <span class="st">"MS FNN"</span>, <span class="st">"MS RNN"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-78-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multi-step-forecasts-2" class="level3">
<h3 class="anchored" data-anchor-id="multi-step-forecasts-2">Multi-step forecasts</h3>
<div id="c0352b48" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>gru_forecast <span class="op">=</span> autoregressive_forecast(model, X_val, <span class="va">True</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>stock.loc[gru_forecast.index, <span class="st">"MS GRU"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> gru_forecast</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cd310fdf" class="cell" data-execution_count="79">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>stock.loc[<span class="st">"2018-12"</span>:<span class="st">"2019"</span>].drop([<span class="st">"Linear"</span>, <span class="st">"Shifted"</span>, <span class="st">"FNN"</span>, <span class="st">"SimpleRNN"</span>, <span class="st">"GRU"</span>], axis<span class="op">=</span><span class="dv">1</span>).plot()</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="st">"2019"</span>, color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"center left"</span>, bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-80-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metrics-3" class="level3">
<h3 class="anchored" data-anchor-id="metrics-3">Metrics</h3>
<p>One-step-ahead forecasts:</p>
<div id="becdf901" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>gru_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, y_pred)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>linear_mse, shifted_mse, nn_mse, rnn_mse, gru_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>(0.6329105517812206,
 0.6367221343873524,
 1.0445119512080592,
 0.644451203191208,
 0.6390273644339947)</code></pre>
</div>
</div>
<p>Multi-step-ahead forecasts:</p>
<div id="3a1b8de8" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>multi_step_gru_mse <span class="op">=</span> <span class="dv">100</span><span class="op">**</span><span class="dv">2</span> <span class="op">*</span> mean_squared_error(y_val, gru_forecast)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>persistence_mse, trend_mse, multi_step_linear_mse, multi_step_fnn_mse, multi_step_rnn_mse, multi_step_gru_mse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>(39.54629367588932,
 37.87104674064297,
 23.84700379112976,
 10.15084682208212,
 10.584407213912131,
 8.111645234476077)</code></pre>
</div>
</div>
</section>
</section>
<section id="simplernn-maths" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="simplernn-maths">SimpleRNN maths</h2>
<section id="the-rank-of-a-time-series" class="level3">
<h3 class="anchored" data-anchor-id="the-rank-of-a-time-series">The rank of a time series</h3>
<p>Say we had <span class="math inline">n</span> observations of a time series <span class="math inline">x_1, x_2, \dots, x_n</span>.</p>
<p>This <span class="math inline">\boldsymbol{x} = (x_1, \dots, x_n)</span> would have shape <span class="math inline">(n,)</span> &amp; rank 1.</p>
<p>If instead we had a batch of <span class="math inline">b</span> time series’</p>
<p><span class="math display">
\boldsymbol{X} = \begin{pmatrix}
x_7 &amp; x_8 &amp; \dots &amp; x_{7+n-1} \\
x_2 &amp; x_3 &amp; \dots &amp; x_{2+n-1} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
x_3 &amp; x_4 &amp; \dots &amp; x_{3+n-1} \\
\end{pmatrix}  \,,
</span></p>
<p>the batch <span class="math inline">\boldsymbol{X}</span> would have shape <span class="math inline">(b, n)</span> &amp; rank 2.</p>
</section>
<section id="multivariate-time-series" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-time-series">Multivariate time series</h3>
<p>Multivariate time series consists of more than 1 variable observation at a given time point. Following example has two variables <code>x</code> and <code>y</code>.</p>
<div class="columns">
<div class="column" style="width:35%;">
<center>
<div id="aae548c1" class="cell" data-execution_count="90">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="88">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;"><span class="math inline">t</span></th>
<th style="text-align: left;"><span class="math inline">x</span></th>
<th style="text-align: left;"><span class="math inline">y</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;"><span class="math inline">x_0</span></td>
<td style="text-align: left;"><span class="math inline">y_0</span></td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;"><span class="math inline">x_1</span></td>
<td style="text-align: left;"><span class="math inline">y_1</span></td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;"><span class="math inline">x_2</span></td>
<td style="text-align: left;"><span class="math inline">y_2</span></td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: left;"><span class="math inline">x_3</span></td>
<td style="text-align: left;"><span class="math inline">y_3</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</center>
</div><div class="column" style="width:65%;">
<p>Say <span class="math inline">n</span> observations of the <span class="math inline">m</span> time series, would be a shape <span class="math inline">(n, m)</span> matrix of rank 2.</p>
<p>In Keras, a batch of <span class="math inline">b</span> of these time series has shape <span class="math inline">(b, n, m)</span> and has rank 3.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use <span class="math inline">\boldsymbol{x}_t \in \mathbb{R}^{1 \times m}</span> to denote the vector of all time series at time <span class="math inline">t</span>. Here, <span class="math inline">\boldsymbol{x}_t = (x_t, y_t)</span>.</p>
</div>
</div>
</section>
<section id="simplernn-1" class="level3">
<h3 class="anchored" data-anchor-id="simplernn-1">SimpleRNN</h3>
<p>Say each prediction is a vector of size <span class="math inline">d</span>, so <span class="math inline">\boldsymbol{y}_t \in \mathbb{R}^{1 \times d}</span>.</p>
<p>Then the main equation of a SimpleRNN, given <span class="math inline">\boldsymbol{y}_0 = \boldsymbol{0}</span>, is</p>
<p><span class="math display"> \boldsymbol{y}_t = \psi\bigl( \boldsymbol{x}_t \boldsymbol{W}_x + \boldsymbol{y}_{t-1} \boldsymbol{W}_y + \boldsymbol{b} \bigr) . </span></p>
<p>Here, <span class="math display">
\begin{aligned}
&amp;\boldsymbol{x}_t \in \mathbb{R}^{1 \times m}, \boldsymbol{W}_x \in \mathbb{R}^{m \times d}, \\
&amp;\boldsymbol{y}_{t-1} \in \mathbb{R}^{1 \times d}, \boldsymbol{W}_y \in \mathbb{R}^{d \times d}, \text{ and } \boldsymbol{b} \in \mathbb{R}^{d}.
\end{aligned}
</span></p>
<p>At each time step, a simple Recurrent Neural Network (RNN) takes an input vector <code>x_t</code>, incorporate it with the information from the previous hidden state <code>{y}_{t-1}</code> and produces an output vector at each time step <code>y_t</code>. The hidden state helps the network remember the context of the previous words, enabling it to make informed predictions about what comes next in the sequence. In a simple RNN, the output at time <code>(t-1)</code> is the same as the hidden state at time <code>t</code>.</p>
</section>
<section id="simplernn-in-batches" class="level3">
<h3 class="anchored" data-anchor-id="simplernn-in-batches">SimpleRNN (in batches)</h3>
<p>The difference between RNN and RNNs with batch processing lies in the way how the neural network handles sequences of input data. With batch processing, the model processes multiple (<span class="math inline">b</span>) input sequences simultaneously. The training data is grouped into batches, and the weights are updated based on the average error across the entire batch. Batch processing often results in more stable weight updates, as the model learns from a diverse set of examples in each batch, reducing the impact of noise in individual sequences.</p>
<p>Say we operate on batches of size <span class="math inline">b</span>, then <span class="math inline">\boldsymbol{Y}_t \in \mathbb{R}^{b \times d}</span>.</p>
<p>The main equation of a SimpleRNN, given <span class="math inline">\boldsymbol{Y}_0 = \boldsymbol{0}</span>, is <span class="math display"> \boldsymbol{Y}_t = \psi\bigl( \boldsymbol{X}_t \boldsymbol{W}_x + \boldsymbol{Y}_{t-1} \boldsymbol{W}_y + \boldsymbol{b} \bigr) . </span> Here, <span class="math display">
\begin{aligned}
&amp;\boldsymbol{X}_t \in \mathbb{R}^{b \times m}, \boldsymbol{W}_x \in \mathbb{R}^{m \times d}, \\
&amp;\boldsymbol{Y}_{t-1} \in \mathbb{R}^{b \times d}, \boldsymbol{W}_y \in \mathbb{R}^{d \times d}, \text{ and } \boldsymbol{b} \in \mathbb{R}^{d}.
\end{aligned}
</span></p>
<div class="footer">
<p>Remember, <span class="math inline">\boldsymbol{X} \in \mathbb{R}^{b \times n \times m}</span>, <span class="math inline">\boldsymbol{Y} \in \mathbb{R}^{b \times d}</span>, and <span class="math inline">\boldsymbol{X}_t</span> is equivalent to <code>X[:, t, :]</code>.</p>
</div>
</section>
<section id="simple-keras-demo" class="level3">
<h3 class="anchored" data-anchor-id="simple-keras-demo">Simple Keras demo</h3>
<div id="a75b219a" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="annotated-cell-69"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-69" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-69-1" class="code-annotation-target"><a href="#annotated-cell-69-1" aria-hidden="true" tabindex="-1"></a>num_obs <span class="op">=</span> <span class="dv">4</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-69" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-69-2" class="code-annotation-target"><a href="#annotated-cell-69-2" aria-hidden="true" tabindex="-1"></a>num_time_steps <span class="op">=</span> <span class="dv">3</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-69" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-69-3" class="code-annotation-target"><a href="#annotated-cell-69-3" aria-hidden="true" tabindex="-1"></a>num_time_series <span class="op">=</span> <span class="dv">2</span></span>
<span id="annotated-cell-69-4"><a href="#annotated-cell-69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-69-5"><a href="#annotated-cell-69-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> (</span>
<span id="annotated-cell-69-6"><a href="#annotated-cell-69-6" aria-hidden="true" tabindex="-1"></a>    np.arange(num_obs <span class="op">*</span> num_time_steps <span class="op">*</span> num_time_series)</span>
<span id="annotated-cell-69-7"><a href="#annotated-cell-69-7" aria-hidden="true" tabindex="-1"></a>    .astype(np.float32)</span>
<span id="annotated-cell-69-8"><a href="#annotated-cell-69-8" aria-hidden="true" tabindex="-1"></a>    .reshape([num_obs, num_time_steps, num_time_series])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-69" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-69-9" class="code-annotation-target"><a href="#annotated-cell-69-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-69-10"><a href="#annotated-cell-69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-69-11"><a href="#annotated-cell-69-11" aria-hidden="true" tabindex="-1"></a>output_size <span class="op">=</span> <span class="dv">1</span></span>
<span id="annotated-cell-69-12"><a href="#annotated-cell-69-12" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-69" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-69" data-code-lines="1" data-code-annotation="1">Defines the number of observations</span>
</dd>
<dt data-target-cell="annotated-cell-69" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-69" data-code-lines="2" data-code-annotation="2">Defines the number of time steps</span>
</dd>
<dt data-target-cell="annotated-cell-69" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-69" data-code-lines="3" data-code-annotation="3">Defines the number of time series</span>
</dd>
<dt data-target-cell="annotated-cell-69" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-69" data-code-lines="9" data-code-annotation="4">Reshapes the array to a range 3 tensor (4,3,2)</span>
</dd>
</dl>
</div>
</div>
<div class="columns">
<div class="column">
<div id="cb5034c3" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="annotated-cell-110"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-110" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-110-1" class="code-annotation-target"><a href="#annotated-cell-110-1" aria-hidden="true" tabindex="-1"></a>X[:<span class="dv">2</span>]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-110" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-110" data-code-lines="1" data-code-annotation="1">Selects the first two slices along the first dimension. Since the tensor of dimensions (4,3,2), <code>X[:2]</code> selects the first two slices (0 and 1) along the first dimension, and returns a sub-tensor of shape (2,3,2).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>array([[[ 0.,  1.],
        [ 2.,  3.],
        [ 4.,  5.]],

       [[ 6.,  7.],
        [ 8.,  9.],
        [10., 11.]]], dtype=float32)</code></pre>
</div>
</div>
</div><div class="column">
<div id="dd1d5f4a" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="annotated-cell-112"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-112" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-112-1" class="code-annotation-target"><a href="#annotated-cell-112-1" aria-hidden="true" tabindex="-1"></a>X[<span class="dv">2</span>:]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-112" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-112" data-code-lines="1" data-code-annotation="1">Selects the last two slices along the first dimension. The first dimension (axis=0) has size 4. Therefore, <code>X[2:]</code> selects the last two slices (2 and 3) along the first dimension, and returns a sub-tensor of shape (2,3,2).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>array([[[12., 13.],
        [14., 15.],
        [16., 17.]],

       [[18., 19.],
        [20., 21.],
        [22., 23.]]], dtype=float32)</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="keras-simplernn" class="level3">
<h3 class="anchored" data-anchor-id="keras-simplernn">Keras’ SimpleRNN</h3>
<p>As usual, the <code>SimpleRNN</code> is just a layer in Keras.</p>
<div id="8f68e9b4" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="annotated-cell-70"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-70-1" class="code-annotation-target"><a href="#annotated-cell-70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> SimpleRNN</span>
<span id="annotated-cell-70-2"><a href="#annotated-cell-70-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-70-3" class="code-annotation-target"><a href="#annotated-cell-70-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1234</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-70-4" class="code-annotation-target"><a href="#annotated-cell-70-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([SimpleRNN(output_size, activation<span class="op">=</span><span class="st">"sigmoid"</span>)])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-70-5" class="code-annotation-target"><a href="#annotated-cell-70-5" aria-hidden="true" tabindex="-1"></a>model.compile(loss<span class="op">=</span><span class="st">"binary_crossentropy"</span>, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>])</span>
<span id="annotated-cell-70-6"><a href="#annotated-cell-70-6" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-70-7" class="code-annotation-target"><a href="#annotated-cell-70-7" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> model.fit(X, y, epochs<span class="op">=</span><span class="dv">500</span>, verbose<span class="op">=</span><span class="va">False</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-70-8" class="code-annotation-target"><a href="#annotated-cell-70-8" aria-hidden="true" tabindex="-1"></a>model.evaluate(X, y, verbose<span class="op">=</span><span class="va">False</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-70" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="1" data-code-annotation="1">Imports the SimpleRNN layer from the Keras library</span>
</dd>
<dt data-target-cell="annotated-cell-70" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="3" data-code-annotation="2">Sets the seed for the random number generator to ensure reproducibility</span>
</dd>
<dt data-target-cell="annotated-cell-70" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="4" data-code-annotation="3">Defines a simple RNN with one output node and sigmoid activation function</span>
</dd>
<dt data-target-cell="annotated-cell-70" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="5" data-code-annotation="4">Specifies binary crossentropy as the loss function (usually used in classification problems), and specifies “accuracy” as the metric to be monitored during training</span>
</dd>
<dt data-target-cell="annotated-cell-70" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="7" data-code-annotation="5">Trains the model for 500 epochs and saves output as <code>hist</code></span>
</dd>
<dt data-target-cell="annotated-cell-70" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="8" data-code-annotation="6">Evaluates the model to obtain a value for the loss and accuracy</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>[0.5405111312866211, 0.75]</code></pre>
</div>
</div>
<p>The predicted probabilities on the training set are:</p>
<div id="3b43b146" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>model.predict(X, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>array([[0.49],
       [0.61],
       [0.72],
       [0.81]], dtype=float32)</code></pre>
</div>
</div>
</section>
<section id="simplernn-weights" class="level3">
<h3 class="anchored" data-anchor-id="simplernn-weights">SimpleRNN weights</h3>
<p>To verify the results of predicted probabilities, we can obtain the weights of the fitted model and calculate the outcome manually as follows.</p>
<div id="69bbb86f" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>model.get_weights()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>[array([[ 0.13],
        [-0.06]], dtype=float32),
 array([[0.51]], dtype=float32),
 array([-0.5], dtype=float32)]</code></pre>
</div>
</div>
<div id="dc6b8b35" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sigmoid(x):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>x))</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>W_x, W_y, b <span class="op">=</span> model.get_weights()</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> np.zeros((num_obs, output_size), dtype<span class="op">=</span>np.float32)</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(num_time_steps):</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    X_t <span class="op">=</span> X[:, t, :]</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> X_t <span class="op">@</span> W_x <span class="op">+</span> Y <span class="op">@</span> W_y <span class="op">+</span> b</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> sigmoid(z)</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>Y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>array([[0.49],
       [0.61],
       [0.72],
       [0.81]], dtype=float32)</code></pre>
</div>
</div>
</section>
</section>
<section id="more-complex-rnns" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="more-complex-rnns">More complex RNNs</h2>
<section id="input-and-output-sequences" class="level3">
<h3 class="anchored" data-anchor-id="input-and-output-sequences">Input and output sequences</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Geron-rnnType.png" class="img-fluid figure-img"></p>
<figcaption>Categories of recurrent neural networks: sequence to sequence, sequence to vector, vector to sequence, encoder-decoder network.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Aurélien Géron (2019), <em>Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</em>, 2nd Edition, Chapter 15.</p>
</div>
</section>
<section id="input-and-output-sequences-1" class="level3">
<h3 class="anchored" data-anchor-id="input-and-output-sequences-1">Input and output sequences</h3>
<ul>
<li>Sequence to sequence: Useful for predicting time series such as using prices over the last <span class="math inline">N</span> days to output the prices shifted one day into the future (i.e.&nbsp;from <span class="math inline">N-1</span> days ago to tomorrow.)</li>
<li>Sequence to vector: ignore all outputs in the previous time steps except for the last one. Example: give a sentiment score to a sequence of words corresponding to a movie review.</li>
</ul>
</section>
<section id="input-and-output-sequences-2" class="level3">
<h3 class="anchored" data-anchor-id="input-and-output-sequences-2">Input and output sequences</h3>
<ul>
<li>Vector to sequence: feed the network the same input vector over and over at each time step and let it output a sequence. Example: given that the input is an image, find a caption for it. The image is treated as an input vector (pixels in an image do not follow a sequence). The caption is a sequence of textual description of the image. A dataset containing images and their descriptions is the input of the RNN.</li>
<li>The Encoder-Decoder: The encoder is a sequence-to-vector network. The decoder is a vector-to-sequence network. Example: Feed the network a sequence in one language. Use the encoder to convert the sentence into a single vector representation. The decoder decodes this vector into the translation of the sentence in another language.</li>
</ul>
</section>
<section id="recurrent-layers-can-be-stacked." class="level3">
<h3 class="anchored" data-anchor-id="recurrent-layers-can-be-stacked.">Recurrent layers can be stacked.</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Geron-recurrentneurondeep.png" class="img-fluid figure-img"></p>
<figcaption><em>Deep RNN</em> unrolled through time.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Aurélien Géron (2019), <em>Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</em>, 2nd Edition, Chapter 15.</p>
</div>
</section>


</section>

<div id="quarto-appendix" class="default"><section id="package-versions" class="level3 appendix" data-visibility="uncounted"><h2 class="anchored quarto-appendix-heading">Package Versions</h2><div class="quarto-appendix-contents">

<div id="39248580" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> watermark <span class="im">import</span> watermark</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(watermark(python<span class="op">=</span><span class="va">True</span>, packages<span class="op">=</span><span class="st">"keras,matplotlib,numpy,pandas,seaborn,scipy,torch,tensorflow,tf_keras"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Python implementation: CPython
Python version       : 3.11.9
IPython version      : 8.25.0

keras     : 3.3.3
matplotlib: 3.9.0
numpy     : 1.26.4
pandas    : 2.2.2
seaborn   : 0.13.2
scipy     : 1.11.0
torch     : 2.3.1
tensorflow: 2.16.1
tf_keras  : 2.16.0
</code></pre>
</div>
</div>
</div></section><section id="glossary" class="level3 appendix" data-visibility="uncounted"><h2 class="anchored quarto-appendix-heading">Glossary</h2><div class="quarto-appendix-contents">

<ul>
<li>GRU</li>
<li>LSTM</li>
<li>recurrent neural networks</li>
<li>SimpleRNN</li>
</ul>


</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Exercises/police-reports.html" class="pagination-link" aria-label="Exercise: Police Reports of US Car Crashes">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Exercise: Police Reports of US Car Crashes</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Exercises/sydney-airport-temperature.html" class="pagination-link" aria-label="Exercise: Sydney Temperature Forecasting">
        <span class="nav-page-text">Exercise: Sydney Temperature Forecasting</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>