<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Patrick Laub">

<title>AI for Actuaries - Recurrent Neural Networks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../Lecture-8-Generative-Networks/generative-networks.html" rel="next">
<link href="../Lecture-6-Uncertainty-Quantification/uncertainty-quantification.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Module 7</a></li><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Recurrent Neural Networks</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">AI for Actuaries</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Module 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-1-Artificial-Intelligence/course-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Overview</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-1-Artificial-Intelligence/python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Module 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-2-Deep-Learning-Keras/deep-learning-keras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deep Learning with Keras</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-2-Deep-Learning-Keras/project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project Details</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Module 3</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-3-Tabular-Data/categorical-variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Categorical Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-3-Tabular-Data/classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Module 4</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-4-Computer-Vision/computer-vision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computer Vision</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Module 5</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-5-Natural-Language-Processing/natural-language-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Natural Language Processing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Module 6</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-6-Uncertainty-Quantification/uncertainty-quantification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Uncertainty Quantification</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Module 7</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Recurrent Neural Networks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">Module 8</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-8-Generative-Networks/generative-networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generative Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-8-Generative-Networks/gans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generative Adversarial Networks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">Module 9</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-9-Advanced-Topics/interpretability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interpretability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lecture-9-Advanced-Topics/exam-revision.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Examinable Topics for Revision</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tensors-time-series" id="toc-tensors-time-series" class="nav-link active" data-scroll-target="#tensors-time-series">Tensors &amp; Time Series</a>
  <ul class="collapse">
  <li><a href="#shapes-of-data" id="toc-shapes-of-data" class="nav-link" data-scroll-target="#shapes-of-data">Shapes of data</a></li>
  <li><a href="#the-axis-argument-in-numpy" id="toc-the-axis-argument-in-numpy" class="nav-link" data-scroll-target="#the-axis-argument-in-numpy">The <code>axis</code> argument in numpy</a></li>
  <li><a href="#using-axis-keepdims" id="toc-using-axis-keepdims" class="nav-link" data-scroll-target="#using-axis-keepdims">Using <code>axis</code> &amp; <code>keepdims</code></a></li>
  <li><a href="#the-rank-of-a-time-series" id="toc-the-rank-of-a-time-series" class="nav-link" data-scroll-target="#the-rank-of-a-time-series">The rank of a time series</a></li>
  <li><a href="#multivariate-time-series" id="toc-multivariate-time-series" class="nav-link" data-scroll-target="#multivariate-time-series">Multivariate time series</a></li>
  </ul></li>
  <li><a href="#some-recurrent-structures" id="toc-some-recurrent-structures" class="nav-link" data-scroll-target="#some-recurrent-structures">Some Recurrent Structures</a>
  <ul class="collapse">
  <li><a href="#recurrence-relation" id="toc-recurrence-relation" class="nav-link" data-scroll-target="#recurrence-relation">Recurrence relation</a></li>
  <li><a href="#diagram-of-an-rnn-cell" id="toc-diagram-of-an-rnn-cell" class="nav-link" data-scroll-target="#diagram-of-an-rnn-cell">Diagram of an RNN cell</a></li>
  <li><a href="#a-simplernn-cell." id="toc-a-simplernn-cell." class="nav-link" data-scroll-target="#a-simplernn-cell.">A SimpleRNN cell.</a></li>
  <li><a href="#simplernn" id="toc-simplernn" class="nav-link" data-scroll-target="#simplernn">SimpleRNN</a></li>
  <li><a href="#simplernn-in-batches" id="toc-simplernn-in-batches" class="nav-link" data-scroll-target="#simplernn-in-batches">SimpleRNN (in batches)</a></li>
  <li><a href="#simple-keras-demo" id="toc-simple-keras-demo" class="nav-link" data-scroll-target="#simple-keras-demo">Simple Keras demo</a></li>
  <li><a href="#keras-simplernn" id="toc-keras-simplernn" class="nav-link" data-scroll-target="#keras-simplernn">Keras’ SimpleRNN</a></li>
  <li><a href="#simplernn-weights" id="toc-simplernn-weights" class="nav-link" data-scroll-target="#simplernn-weights">SimpleRNN weights</a></li>
  <li><a href="#lstm-internals" id="toc-lstm-internals" class="nav-link" data-scroll-target="#lstm-internals">LSTM internals</a></li>
  <li><a href="#gru-internals" id="toc-gru-internals" class="nav-link" data-scroll-target="#gru-internals">GRU internals</a></li>
  </ul></li>
  <li><a href="#recurrent-neural-networks" id="toc-recurrent-neural-networks" class="nav-link" data-scroll-target="#recurrent-neural-networks">Recurrent Neural Networks</a>
  <ul class="collapse">
  <li><a href="#basic-facts-of-rnns" id="toc-basic-facts-of-rnns" class="nav-link" data-scroll-target="#basic-facts-of-rnns">Basic facts of RNNs</a></li>
  <li><a href="#applications" id="toc-applications" class="nav-link" data-scroll-target="#applications">Applications</a></li>
  <li><a href="#input-and-output-sequences" id="toc-input-and-output-sequences" class="nav-link" data-scroll-target="#input-and-output-sequences">Input and output sequences</a></li>
  <li><a href="#input-and-output-sequences-1" id="toc-input-and-output-sequences-1" class="nav-link" data-scroll-target="#input-and-output-sequences-1">Input and output sequences</a></li>
  <li><a href="#input-and-output-sequences-2" id="toc-input-and-output-sequences-2" class="nav-link" data-scroll-target="#input-and-output-sequences-2">Input and output sequences</a></li>
  <li><a href="#recurrent-layers-can-be-stacked." id="toc-recurrent-layers-can-be-stacked." class="nav-link" data-scroll-target="#recurrent-layers-can-be-stacked.">Recurrent layers can be stacked.</a></li>
  </ul></li>
  <li><a href="#corelogic-hedonic-home-value-index" id="toc-corelogic-hedonic-home-value-index" class="nav-link" data-scroll-target="#corelogic-hedonic-home-value-index">CoreLogic Hedonic Home Value Index</a>
  <ul class="collapse">
  <li><a href="#australian-house-price-indices" id="toc-australian-house-price-indices" class="nav-link" data-scroll-target="#australian-house-price-indices">Australian House Price Indices</a></li>
  <li><a href="#percentage-changes" id="toc-percentage-changes" class="nav-link" data-scroll-target="#percentage-changes">Percentage changes</a></li>
  <li><a href="#percentage-changes-1" id="toc-percentage-changes-1" class="nav-link" data-scroll-target="#percentage-changes-1">Percentage changes</a></li>
  <li><a href="#the-size-of-the-changes" id="toc-the-size-of-the-changes" class="nav-link" data-scroll-target="#the-size-of-the-changes">The size of the changes</a></li>
  </ul></li>
  <li><a href="#splitting-time-series-data" id="toc-splitting-time-series-data" class="nav-link" data-scroll-target="#splitting-time-series-data">Splitting time series data</a>
  <ul class="collapse">
  <li><a href="#split-without-shuffling" id="toc-split-without-shuffling" class="nav-link" data-scroll-target="#split-without-shuffling">Split <em>without</em> shuffling</a></li>
  <li><a href="#subsequences-of-a-time-series" id="toc-subsequences-of-a-time-series" class="nav-link" data-scroll-target="#subsequences-of-a-time-series">Subsequences of a time series</a></li>
  <li><a href="#on-time-series-splits" id="toc-on-time-series-splits" class="nav-link" data-scroll-target="#on-time-series-splits">On time series splits</a></li>
  <li><a href="#on-time-series-splits-ii" id="toc-on-time-series-splits-ii" class="nav-link" data-scroll-target="#on-time-series-splits-ii">On time series splits II</a></li>
  </ul></li>
  <li><a href="#predicting-sydney-house-prices" id="toc-predicting-sydney-house-prices" class="nav-link" data-scroll-target="#predicting-sydney-house-prices">Predicting Sydney House Prices</a>
  <ul class="collapse">
  <li><a href="#creating-dataset-objects" id="toc-creating-dataset-objects" class="nav-link" data-scroll-target="#creating-dataset-objects">Creating dataset objects</a></li>
  <li><a href="#converting-dataset-to-numpy" id="toc-converting-dataset-to-numpy" class="nav-link" data-scroll-target="#converting-dataset-to-numpy">Converting <code>Dataset</code> to numpy</a></li>
  <li><a href="#a-dense-network" id="toc-a-dense-network" class="nav-link" data-scroll-target="#a-dense-network">A dense network</a></li>
  <li><a href="#plot-the-model" id="toc-plot-the-model" class="nav-link" data-scroll-target="#plot-the-model">Plot the model</a></li>
  <li><a href="#assess-the-fits" id="toc-assess-the-fits" class="nav-link" data-scroll-target="#assess-the-fits">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions" id="toc-plotting-the-predictions" class="nav-link" data-scroll-target="#plotting-the-predictions">Plotting the predictions</a></li>
  <li><a href="#a-simplernn-layer" id="toc-a-simplernn-layer" class="nav-link" data-scroll-target="#a-simplernn-layer">A <code>SimpleRNN</code> layer</a></li>
  <li><a href="#assess-the-fits-1" id="toc-assess-the-fits-1" class="nav-link" data-scroll-target="#assess-the-fits-1">Assess the fits</a></li>
  <li><a href="#plot-the-model-1" id="toc-plot-the-model-1" class="nav-link" data-scroll-target="#plot-the-model-1">Plot the model</a></li>
  <li><a href="#plotting-the-predictions-1" id="toc-plotting-the-predictions-1" class="nav-link" data-scroll-target="#plotting-the-predictions-1">Plotting the predictions</a></li>
  <li><a href="#a-lstm-layer" id="toc-a-lstm-layer" class="nav-link" data-scroll-target="#a-lstm-layer">A <code>LSTM</code> layer</a></li>
  <li><a href="#assess-the-fits-2" id="toc-assess-the-fits-2" class="nav-link" data-scroll-target="#assess-the-fits-2">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-2" id="toc-plotting-the-predictions-2" class="nav-link" data-scroll-target="#plotting-the-predictions-2">Plotting the predictions</a></li>
  <li><a href="#a-gru-layer" id="toc-a-gru-layer" class="nav-link" data-scroll-target="#a-gru-layer">A <code>GRU</code> layer</a></li>
  <li><a href="#assess-the-fits-3" id="toc-assess-the-fits-3" class="nav-link" data-scroll-target="#assess-the-fits-3">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-3" id="toc-plotting-the-predictions-3" class="nav-link" data-scroll-target="#plotting-the-predictions-3">Plotting the predictions</a></li>
  <li><a href="#two-gru-layers" id="toc-two-gru-layers" class="nav-link" data-scroll-target="#two-gru-layers">Two <code>GRU</code> layers</a></li>
  <li><a href="#assess-the-fits-4" id="toc-assess-the-fits-4" class="nav-link" data-scroll-target="#assess-the-fits-4">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-4" id="toc-plotting-the-predictions-4" class="nav-link" data-scroll-target="#plotting-the-predictions-4">Plotting the predictions</a></li>
  <li><a href="#compare-the-models" id="toc-compare-the-models" class="nav-link" data-scroll-target="#compare-the-models">Compare the models</a></li>
  <li><a href="#test-set" id="toc-test-set" class="nav-link" data-scroll-target="#test-set">Test set</a></li>
  </ul></li>
  <li><a href="#predicting-multiple-time-series" id="toc-predicting-multiple-time-series" class="nav-link" data-scroll-target="#predicting-multiple-time-series">Predicting Multiple Time Series</a>
  <ul class="collapse">
  <li><a href="#creating-dataset-objects-1" id="toc-creating-dataset-objects-1" class="nav-link" data-scroll-target="#creating-dataset-objects-1">Creating dataset objects</a></li>
  <li><a href="#converting-dataset-to-numpy-1" id="toc-converting-dataset-to-numpy-1" class="nav-link" data-scroll-target="#converting-dataset-to-numpy-1">Converting <code>Dataset</code> to numpy</a></li>
  <li><a href="#a-dense-network-1" id="toc-a-dense-network-1" class="nav-link" data-scroll-target="#a-dense-network-1">A dense network</a></li>
  <li><a href="#plot-the-model-2" id="toc-plot-the-model-2" class="nav-link" data-scroll-target="#plot-the-model-2">Plot the model</a></li>
  <li><a href="#assess-the-fits-5" id="toc-assess-the-fits-5" class="nav-link" data-scroll-target="#assess-the-fits-5">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-5" id="toc-plotting-the-predictions-5" class="nav-link" data-scroll-target="#plotting-the-predictions-5">Plotting the predictions</a></li>
  <li><a href="#a-simplernn-layer-1" id="toc-a-simplernn-layer-1" class="nav-link" data-scroll-target="#a-simplernn-layer-1">A <code>SimpleRNN</code> layer</a></li>
  <li><a href="#assess-the-fits-6" id="toc-assess-the-fits-6" class="nav-link" data-scroll-target="#assess-the-fits-6">Assess the fits</a></li>
  <li><a href="#plot-the-model-3" id="toc-plot-the-model-3" class="nav-link" data-scroll-target="#plot-the-model-3">Plot the model</a></li>
  <li><a href="#plotting-the-predictions-6" id="toc-plotting-the-predictions-6" class="nav-link" data-scroll-target="#plotting-the-predictions-6">Plotting the predictions</a></li>
  <li><a href="#a-lstm-layer-1" id="toc-a-lstm-layer-1" class="nav-link" data-scroll-target="#a-lstm-layer-1">A <code>LSTM</code> layer</a></li>
  <li><a href="#assess-the-fits-7" id="toc-assess-the-fits-7" class="nav-link" data-scroll-target="#assess-the-fits-7">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-7" id="toc-plotting-the-predictions-7" class="nav-link" data-scroll-target="#plotting-the-predictions-7">Plotting the predictions</a></li>
  <li><a href="#a-gru-layer-1" id="toc-a-gru-layer-1" class="nav-link" data-scroll-target="#a-gru-layer-1">A <code>GRU</code> layer</a></li>
  <li><a href="#assess-the-fits-8" id="toc-assess-the-fits-8" class="nav-link" data-scroll-target="#assess-the-fits-8">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-8" id="toc-plotting-the-predictions-8" class="nav-link" data-scroll-target="#plotting-the-predictions-8">Plotting the predictions</a></li>
  <li><a href="#two-gru-layers-1" id="toc-two-gru-layers-1" class="nav-link" data-scroll-target="#two-gru-layers-1">Two <code>GRU</code> layers</a></li>
  <li><a href="#assess-the-fits-9" id="toc-assess-the-fits-9" class="nav-link" data-scroll-target="#assess-the-fits-9">Assess the fits</a></li>
  <li><a href="#plotting-the-predictions-9" id="toc-plotting-the-predictions-9" class="nav-link" data-scroll-target="#plotting-the-predictions-9">Plotting the predictions</a></li>
  <li><a href="#compare-the-models-1" id="toc-compare-the-models-1" class="nav-link" data-scroll-target="#compare-the-models-1">Compare the models</a></li>
  <li><a href="#test-set-1" id="toc-test-set-1" class="nav-link" data-scroll-target="#test-set-1">Test set</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
  <ul class="collapse">
  <li><a href="#package-versions" id="toc-package-versions" class="nav-link" data-scroll-target="#package-versions">Package Versions</a></li>
  <li><a href="#glossary" id="toc-glossary" class="nav-link" data-scroll-target="#glossary">Glossary</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="rnns-and-time-series.slides.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Module 7</a></li><li class="breadcrumb-item"><a href="../Lecture-7-Recurrent-Neural-Networks-And-Time-Series/rnns-and-time-series.html">Recurrent Neural Networks</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Recurrent Neural Networks</h1>
<p class="subtitle lead">ACTL3143 &amp; ACTL5111 Deep Learning for Actuaries</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Patrick Laub </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div id="1fb44df1" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the package imports</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, Input</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.callbacks <span class="im">import</span> EarlyStopping</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="tensors-time-series" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Tensors &amp; Time Series</h1>
<section id="shapes-of-data" class="level2">
<h2 class="anchored" data-anchor-id="shapes-of-data">Shapes of data</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="medium-tensor-rank.png" class="img-fluid figure-img"></p>
<figcaption>Illustration of tensors of different rank.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Paras Patidar (2019), <a href="https://medium.com/mlait/tensors-representation-of-data-in-neural-networks-bbe8a711b93b">Tensors — Representation of Data In Neural Networks</a>, Medium article.</p>
</div>
</section>
<section id="the-axis-argument-in-numpy" class="level2">
<h2 class="anchored" data-anchor-id="the-axis-argument-in-numpy">The <code>axis</code> argument in numpy</h2>
<p>Starting with a <span class="math inline">(3, 4)</span>-shaped matrix:</p>
<div id="b000c4d7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.arange(<span class="dv">12</span>).reshape(<span class="dv">3</span>,<span class="dv">4</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>array([[ 0,  1,  2,  3],
       [ 4,  5,  6,  7],
       [ 8,  9, 10, 11]])</code></pre>
</div>
</div>
<p>The above code creates an array with values from 0 to 11 and converts that array into a matrix with 3 rows and 4 columns.</p>
<div class="columns">
<div class="column">
<p><code>axis=0</code>: <span class="math inline">(3, 4) \leadsto (4,)</span>.</p>
<div id="a5d0e882" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>X.sum(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>array([12, 15, 18, 21])</code></pre>
</div>
</div>
<p>The above code returns the column sum. This changes the shape of the matrix from <span class="math inline">(3,4)</span> to <span class="math inline">(4,)</span>. Similarly, <code>X.sum(axis=1)</code> returns row sums and will change the shape of the matrix from <span class="math inline">(3,4)</span> to <span class="math inline">(3,)</span>.</p>
</div><div class="column">
<p><code>axis=1</code>: <span class="math inline">(3, 4) \leadsto (3,)</span>.</p>
<div id="b9f4a067" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>X.prod(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>array([   0,  840, 7920])</code></pre>
</div>
</div>
</div>
</div>
<p>The return value’s rank is one less than the input’s rank.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>axis</code> parameter tells us which dimension is removed.</p>
</div>
</div>
</section>
<section id="using-axis-keepdims" class="level2">
<h2 class="anchored" data-anchor-id="using-axis-keepdims">Using <code>axis</code> &amp; <code>keepdims</code></h2>
<p>With <code>keepdims=True</code>, the rank doesn’t change.</p>
<div id="c7924344" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.arange(<span class="dv">12</span>).reshape(<span class="dv">3</span>,<span class="dv">4</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([[ 0,  1,  2,  3],
       [ 4,  5,  6,  7],
       [ 8,  9, 10, 11]])</code></pre>
</div>
</div>
<div class="columns">
<div class="column">
<p><code>axis=0</code>: <span class="math inline">(3, 4) \leadsto (1, 4)</span>.</p>
<div id="eac8f82d" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>X.sum(axis<span class="op">=</span><span class="dv">0</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>array([[12, 15, 18, 21]])</code></pre>
</div>
</div>
</div><div class="column">
<p><code>axis=1</code>: <span class="math inline">(3, 4) \leadsto (3, 1)</span>.</p>
<div id="613ae72d" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>X.prod(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>array([[   0],
       [ 840],
       [7920]])</code></pre>
</div>
</div>
</div>
</div>
<div class="columns">
<div class="column">
<div id="dd6c9bc3" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">/</span> X.sum(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: operands could not be broadcast together with shapes (3,4) (3,) </code></pre>
</div>
</div>
</div><div class="column">
<div id="38df636a" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">/</span> X.sum(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>array([[0.  , 0.17, 0.33, 0.5 ],
       [0.18, 0.23, 0.27, 0.32],
       [0.21, 0.24, 0.26, 0.29]])</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="the-rank-of-a-time-series" class="level2">
<h2 class="anchored" data-anchor-id="the-rank-of-a-time-series">The rank of a time series</h2>
<p>Say we had <span class="math inline">n</span> observations of a time series <span class="math inline">x_1, x_2, \dots, x_n</span>.</p>
<p>This <span class="math inline">\mathbf{x} = (x_1, \dots, x_n)</span> would have shape <span class="math inline">(n,)</span> &amp; rank 1.</p>
<p>If instead we had a batch of <span class="math inline">b</span> time series’</p>
<p><span class="math display">
\mathbf{X} = \begin{pmatrix}
x_7 &amp; x_8 &amp; \dots &amp; x_{7+n-1} \\
x_2 &amp; x_3 &amp; \dots &amp; x_{2+n-1} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
x_3 &amp; x_4 &amp; \dots &amp; x_{3+n-1} \\
\end{pmatrix}  \,,
</span></p>
<p>the batch <span class="math inline">\mathbf{X}</span> would have shape <span class="math inline">(b, n)</span> &amp; rank 2.</p>
</section>
<section id="multivariate-time-series" class="level2">
<h2 class="anchored" data-anchor-id="multivariate-time-series">Multivariate time series</h2>
<p>Multivariate time series consists of more than 1 variable observation at a given time point. Following example has two variables <code>x</code> and <code>y</code>.</p>
<div class="columns">
<div class="column" style="width:35%;">
<center>
<div id="50c1bf7a" class="cell" data-execution_count="11">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="11">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;"><span class="math inline">t</span></th>
<th style="text-align: left;"><span class="math inline">x</span></th>
<th style="text-align: left;"><span class="math inline">y</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;"><span class="math inline">x_0</span></td>
<td style="text-align: left;"><span class="math inline">y_0</span></td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;"><span class="math inline">x_1</span></td>
<td style="text-align: left;"><span class="math inline">y_1</span></td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;"><span class="math inline">x_2</span></td>
<td style="text-align: left;"><span class="math inline">y_2</span></td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: left;"><span class="math inline">x_3</span></td>
<td style="text-align: left;"><span class="math inline">y_3</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</center>
</div><div class="column" style="width:65%;">
<p>Say <span class="math inline">n</span> observations of the <span class="math inline">m</span> time series, would be a shape <span class="math inline">(n, m)</span> matrix of rank 2.</p>
<p>In Keras, a batch of <span class="math inline">b</span> of these time series has shape <span class="math inline">(b, n, m)</span> and has rank 3.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use <span class="math inline">\mathbf{x}_t \in \mathbb{R}^{1 \times m}</span> to denote the vector of all time series at time <span class="math inline">t</span>. Here, <span class="math inline">\mathbf{x}_t = (x_t, y_t)</span>.</p>
</div>
</div>
</section>
</section>
<section id="some-recurrent-structures" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Some Recurrent Structures</h1>
<section id="recurrence-relation" class="level2">
<h2 class="anchored" data-anchor-id="recurrence-relation">Recurrence relation</h2>
<blockquote class="blockquote">
<p>A recurrence relation is an equation that expresses each element of a sequence as a function of the preceding ones. More precisely, in the case where only the immediately preceding element is involved, a recurrence relation has the form</p>
<p><span class="math display"> u_n = \psi(n, u_{n-1}) \quad \text{ for } \quad n &gt; 0.</span></p>
</blockquote>
<p><strong>Example</strong>: Factorial <span class="math inline">n! = n (n-1)!</span> for <span class="math inline">n &gt; 0</span> given <span class="math inline">0! = 1</span>.</p>
<div class="footer">
<p>Source: Wikipedia, <a href="https://en.wikipedia.org/wiki/Recurrence_relation#Definition">Recurrence relation</a>.</p>
</div>
</section>
<section id="diagram-of-an-rnn-cell" class="level2">
<h2 class="anchored" data-anchor-id="diagram-of-an-rnn-cell">Diagram of an RNN cell</h2>
<p>The RNN processes each data in the sequence one by one, while keeping memory of what came before.</p>
<p>The following figure shows how the recurrent neural network combines an input <code>X_l</code> with a preprocessed state of the process <code>A_l</code> to produce the output <code>O_l</code>. RNNs have a cyclic information processing structure that enables them to pass information sequentially from previous inputs. RNNs can capture dependencies and patterns in sequential data, making them useful for analysing time series data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ISLR2-10_12.svg" class="img-fluid figure-img"></p>
<figcaption>Schematic of a simple recurrent neural network. E.g. SimpleRNN, LSTM, or GRU.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: James et al (2022), <a href="https://www.statlearning.com/">An Introduction to Statistical Learning</a>, 2nd edition, Figure 10.12.</p>
</div>
</section>
<section id="a-simplernn-cell." class="level2">
<h2 class="anchored" data-anchor-id="a-simplernn-cell.">A SimpleRNN cell.</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="colah-LSTM3-SimpleRNN.png" class="img-fluid figure-img"></p>
<figcaption>Diagram of a SimpleRNN cell.</figcaption>
</figure>
</div>
<p>All the outputs before the final one are often discarded.</p>
<div class="footer">
<p>Source: Christopher Olah (2015), <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">Understanding LSTM Networks</a>, Colah’s Blog.</p>
</div>
</section>
<section id="simplernn" class="level2">
<h2 class="anchored" data-anchor-id="simplernn">SimpleRNN</h2>
<p>Say each prediction is a vector of size <span class="math inline">d</span>, so <span class="math inline">\mathbf{y}_t \in \mathbb{R}^{1 \times d}</span>.</p>
<p>Then the main equation of a SimpleRNN, given <span class="math inline">\mathbf{y}_0 = \mathbf{0}</span>, is</p>
<p><span class="math display"> \mathbf{y}_t = \psi\bigl( \mathbf{x}_t \mathbf{W}_x + \mathbf{y}_{t-1} \mathbf{W}_y + \mathbf{b} \bigr) . </span></p>
<p>Here, <span class="math display">
\begin{aligned}
&amp;\mathbf{x}_t \in \mathbb{R}^{1 \times m}, \mathbf{W}_x \in \mathbb{R}^{m \times d}, \\
&amp;\mathbf{y}_{t-1} \in \mathbb{R}^{1 \times d}, \mathbf{W}_y \in \mathbb{R}^{d \times d}, \text{ and } \mathbf{b} \in \mathbb{R}^{d}.
\end{aligned}
</span></p>
<p>At each time step, a simple Recurrent Neural Network (RNN) takes an input vector <code>x_t</code>, incorporate it with the information from the previous hidden state <code>{y}_{t-1}</code> and produces an output vector at each time step <code>y_t</code>. The hidden state helps the network remember the context of the previous words, enabling it to make informed predictions about what comes next in the sequence. In a simple RNN, the output at time <code>(t-1)</code> is the same as the hidden state at time <code>t</code>.</p>
</section>
<section id="simplernn-in-batches" class="level2">
<h2 class="anchored" data-anchor-id="simplernn-in-batches">SimpleRNN (in batches)</h2>
<p>The difference between RNN and RNNs with batch processing lies in the way how the neural network handles sequences of input data. With batch processing, the model processes multiple (<span class="math inline">b</span>) input sequences simultaneously. The training data is grouped into batches, and the weights are updated based on the average error across the entire batch. Batch processing often results in more stable weight updates, as the model learns from a diverse set of examples in each batch, reducing the impact of noise in individual sequences.</p>
<p>Say we operate on batches of size <span class="math inline">b</span>, then <span class="math inline">\mathbf{Y}_t \in \mathbb{R}^{b \times d}</span>.</p>
<p>The main equation of a SimpleRNN, given <span class="math inline">\mathbf{Y}_0 = \mathbf{0}</span>, is <span class="math display"> \mathbf{Y}_t = \psi\bigl( \mathbf{X}_t \mathbf{W}_x + \mathbf{Y}_{t-1} \mathbf{W}_y + \mathbf{b} \bigr) . </span> Here, <span class="math display">
\begin{aligned}
&amp;\mathbf{X}_t \in \mathbb{R}^{b \times m}, \mathbf{W}_x \in \mathbb{R}^{m \times d}, \\
&amp;\mathbf{Y}_{t-1} \in \mathbb{R}^{b \times d}, \mathbf{W}_y \in \mathbb{R}^{d \times d}, \text{ and } \mathbf{b} \in \mathbb{R}^{d}.
\end{aligned}
</span></p>
<div class="footer">
<p>Remember, <span class="math inline">\mathbf{X} \in \mathbb{R}^{b \times n \times m}</span>, <span class="math inline">\mathbf{Y} \in \mathbb{R}^{b \times d}</span>, and <span class="math inline">\mathbf{X}_t</span> is equivalent to <code>X[:, t, :]</code>.</p>
</div>
</section>
<section id="simple-keras-demo" class="level2">
<h2 class="anchored" data-anchor-id="simple-keras-demo">Simple Keras demo</h2>
<div id="b20dd7d6" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-3-1" class="code-annotation-target"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>num_obs <span class="op">=</span> <span class="dv">4</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-3-2" class="code-annotation-target"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a>num_time_steps <span class="op">=</span> <span class="dv">3</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-3-3" class="code-annotation-target"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a>num_time_series <span class="op">=</span> <span class="dv">2</span></span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.arange(num_obs<span class="op">*</span>num_time_steps<span class="op">*</span>num_time_series).astype(np.float32) <span class="op">\</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-3-6" class="code-annotation-target"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a>        .reshape([num_obs, num_time_steps, num_time_series])</span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a>output_size <span class="op">=</span> <span class="dv">1</span>                                                                 </span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="1" data-code-annotation="1">Defines the number of observations</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="2" data-code-annotation="2">Defines the number of time steps</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="3" data-code-annotation="3">Defines the number of time series</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="6" data-code-annotation="4">Reshapes the array to a range 3 tensor (4,3,2)</span>
</dd>
</dl>
</div>
</div>
<div class="columns">
<div class="column">
<div id="9e6d389b" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="annotated-cell-63"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-63" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-63-1" class="code-annotation-target"><a href="#annotated-cell-63-1" aria-hidden="true" tabindex="-1"></a>X[:<span class="dv">2</span>]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-63" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-63" data-code-lines="1" data-code-annotation="1">Selects the first two slices along the first dimension. Since the tensor of dimensions (4,3,2), <code>X[:2]</code> selects the first two slices (0 and 1) along the first dimension, and returns a sub-tensor of shape (2,3,2).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>array([[[ 0.,  1.],
        [ 2.,  3.],
        [ 4.,  5.]],

       [[ 6.,  7.],
        [ 8.,  9.],
        [10., 11.]]], dtype=float32)</code></pre>
</div>
</div>
</div><div class="column">
<div id="9199d035" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="annotated-cell-65"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-65" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-65-1" class="code-annotation-target"><a href="#annotated-cell-65-1" aria-hidden="true" tabindex="-1"></a>X[<span class="dv">2</span>:]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-65" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-65" data-code-lines="1" data-code-annotation="1">Selects the last two slices along the first dimension. The first dimension (axis=0) has size 4. Therefore, <code>X[2:]</code> selects the last two slices (2 and 3) along the first dimension, and returns a sub-tensor of shape (2,3,2).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array([[[12., 13.],
        [14., 15.],
        [16., 17.]],

       [[18., 19.],
        [20., 21.],
        [22., 23.]]], dtype=float32)</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="keras-simplernn" class="level2">
<h2 class="anchored" data-anchor-id="keras-simplernn">Keras’ SimpleRNN</h2>
<p>As usual, the <code>SimpleRNN</code> is just a layer in Keras.</p>
<div id="f0bcc181" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-1" class="code-annotation-target"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> SimpleRNN</span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-4-3" class="code-annotation-target"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1234</span>)</span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-4-5" class="code-annotation-target"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>  SimpleRNN(output_size, activation<span class="op">=</span><span class="st">"sigmoid"</span>)</span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a>])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-4-7" class="code-annotation-target"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a>model.compile(loss<span class="op">=</span><span class="st">"binary_crossentropy"</span>, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>])</span>
<span id="annotated-cell-4-8"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-4-9" class="code-annotation-target"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> model.fit(X, y, epochs<span class="op">=</span><span class="dv">500</span>, verbose<span class="op">=</span><span class="va">False</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-4-10" class="code-annotation-target"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a>model.evaluate(X, y, verbose<span class="op">=</span><span class="va">False</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="1" data-code-annotation="1">Imports the SimpleRNN layer from the Keras library</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="3" data-code-annotation="2">Sets the seed for the random number generator to ensure reproducibility</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="5" data-code-annotation="3">Defines a simple RNN with one output node and sigmoid activation function</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="7" data-code-annotation="4">Specifies binary crossentropy as the loss function (usually used in classification problems), and specifies “accuracy” as the metric to be monitored during training</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="9" data-code-annotation="5">Trains the model for 500 epochs and saves output as <code>hist</code></span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="10" data-code-annotation="6">Evaluates the model to obtain a value for the loss and accuracy</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>[8.05906867980957, 0.5]</code></pre>
</div>
</div>
<p>The predicted probabilities on the training set are:</p>
<div id="a87bcb13" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>model.predict(X, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>array([[8.56e-05],
       [2.25e-10],
       [5.98e-16],
       [1.59e-21]], dtype=float32)</code></pre>
</div>
</div>
</section>
<section id="simplernn-weights" class="level2">
<h2 class="anchored" data-anchor-id="simplernn-weights">SimpleRNN weights</h2>
<p>To verify the results of predicted probabilities, we can obtain the weights of the fitted model and calculate the outcome manually as follows.</p>
<div id="b9d81dff" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>model.get_weights()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>[array([[-1.47],
        [-0.67]], dtype=float32),
 array([[0.99]], dtype=float32),
 array([-0.14], dtype=float32)]</code></pre>
</div>
</div>
<div id="a116c098" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sigmoid(x):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> np.exp(<span class="op">-</span>x))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>W_x, W_y, b <span class="op">=</span> model.get_weights()</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> np.zeros((num_obs, output_size), dtype<span class="op">=</span>np.float32)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(num_time_steps):</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    X_t <span class="op">=</span> X[:, t, :]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> X_t <span class="op">@</span> W_x <span class="op">+</span> Y <span class="op">@</span> W_y <span class="op">+</span> b</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> sigmoid(z)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>Y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array([[8.56e-05],
       [2.25e-10],
       [5.98e-16],
       [1.59e-21]], dtype=float32)</code></pre>
</div>
</div>
</section>
<section id="lstm-internals" class="level2">
<h2 class="anchored" data-anchor-id="lstm-internals">LSTM internals</h2>
<p>Simple RNN structures encounter vanishing gradient problems, hence, struggle with learning long term dependencies. LSTM are designed to overcome this problem. LSTMs have a more complex network structure (contains more memory cells and gating mechanisms) and can better regulate the information flow.</p>
<p><img src="colah-LSTM3-chain.png" class="img-fluid" alt="Diagram of an LSTM cell."> <img src="colah-LSTM2-notation.png" class="img-fluid" alt="Notation for the diagram."></p>
<div class="footer">
<p>Source: Christopher Olah (2015), <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">Understanding LSTM Networks</a>, Colah’s Blog.</p>
</div>
</section>
<section id="gru-internals" class="level2">
<h2 class="anchored" data-anchor-id="gru-internals">GRU internals</h2>
<p>GRUs are simpler compared to LSTM, hence, computationally more efficient than LSTMs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="colah-LSTM3-var-GRU.png" class="img-fluid figure-img"></p>
<figcaption>Diagram of a GRU cell.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Christopher Olah (2015), <a href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">Understanding LSTM Networks</a>, Colah’s Blog.</p>
</div>
</section>
</section>
<section id="recurrent-neural-networks" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Recurrent Neural Networks</h1>
<section id="basic-facts-of-rnns" class="level2">
<h2 class="anchored" data-anchor-id="basic-facts-of-rnns">Basic facts of RNNs</h2>
<ul>
<li>A recurrent neural network is a type of neural network that is designed to process sequences of data (e.g.&nbsp;time series, sentences).</li>
<li>A recurrent neural network is any network that contains a recurrent layer.</li>
<li>A recurrent layer is a layer that processes data in a sequence.</li>
<li>An RNN can have one or more recurrent layers.</li>
<li>Weights are shared over time; this allows the model to be used on arbitrary-length sequences.</li>
</ul>
</section>
<section id="applications" class="level2">
<h2 class="anchored" data-anchor-id="applications">Applications</h2>
<ul>
<li>Forecasting: revenue forecast, weather forecast, predict disease rate from medical history, etc.</li>
<li>Classification: given a time series of the activities of a visitor on a website, classify whether the visitor is a bot or a human.</li>
<li>Event detection: given a continuous data stream, identify the occurrence of a specific event. Example: Detect utterances like “Hey Alexa” from an audio stream.</li>
<li>Anomaly detection: given a continuous data stream, detect anything unusual happening. Example: Detect unusual activity on the corporate network.</li>
</ul>
</section>
<section id="input-and-output-sequences" class="level2">
<h2 class="anchored" data-anchor-id="input-and-output-sequences">Input and output sequences</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Geron-rnnType.png" class="img-fluid figure-img"></p>
<figcaption>Categories of recurrent neural networks: sequence to sequence, sequence to vector, vector to sequence, encoder-decoder network.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Aurélien Géron (2019), <em>Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</em>, 2nd Edition, Chapter 15.</p>
</div>
</section>
<section id="input-and-output-sequences-1" class="level2">
<h2 class="anchored" data-anchor-id="input-and-output-sequences-1">Input and output sequences</h2>
<ul>
<li>Sequence to sequence: Useful for predicting time series such as using prices over the last <span class="math inline">N</span> days to output the prices shifted one day into the future (i.e.&nbsp;from <span class="math inline">N-1</span> days ago to tomorrow.)</li>
<li>Sequence to vector: ignore all outputs in the previous time steps except for the last one. Example: give a sentiment score to a sequence of words corresponding to a movie review.</li>
</ul>
</section>
<section id="input-and-output-sequences-2" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="input-and-output-sequences-2">Input and output sequences</h2>
<ul>
<li>Vector to sequence: feed the network the same input vector over and over at each time step and let it output a sequence. Example: given that the input is an image, find a caption for it. The image is treated as an input vector (pixels in an image do not follow a sequence). The caption is a sequence of textual description of the image. A dataset containing images and their descriptions is the input of the RNN.</li>
<li>The Encoder-Decoder: The encoder is a sequence-to-vector network. The decoder is a vector-to-sequence network. Example: Feed the network a sequence in one language. Use the encoder to convert the sentence into a single vector representation. The decoder decodes this vector into the translation of the sentence in another language.</li>
</ul>
</section>
<section id="recurrent-layers-can-be-stacked." class="level2">
<h2 class="anchored" data-anchor-id="recurrent-layers-can-be-stacked.">Recurrent layers can be stacked.</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Geron-recurrentneurondeep.png" class="img-fluid figure-img"></p>
<figcaption><em>Deep RNN</em> unrolled through time.</figcaption>
</figure>
</div>
<div class="footer">
<p>Source: Aurélien Géron (2019), <em>Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</em>, 2nd Edition, Chapter 15.</p>
</div>
</section>
</section>
<section id="corelogic-hedonic-home-value-index" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">CoreLogic Hedonic Home Value Index</h1>
<section id="australian-house-price-indices" class="level2">
<h2 class="anchored" data-anchor-id="australian-house-price-indices">Australian House Price Indices</h2>
<div id="4daeabb2" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="percentage-changes" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="percentage-changes">Percentage changes</h2>
<div id="b9e3a445" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>changes <span class="op">=</span> house_prices.pct_change().dropna()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>changes.round(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Brisbane</th>
<th data-quarto-table-cell-role="th">East_Bris</th>
<th data-quarto-table-cell-role="th">North_Bris</th>
<th data-quarto-table-cell-role="th">West_Bris</th>
<th data-quarto-table-cell-role="th">Melbourne</th>
<th data-quarto-table-cell-role="th">North_Syd</th>
<th data-quarto-table-cell-role="th">Sydney</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1990-02-28</td>
<td>0.03</td>
<td>-0.01</td>
<td>0.01</td>
<td>0.01</td>
<td>0.00</td>
<td>-0.00</td>
<td>-0.02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990-03-31</td>
<td>0.01</td>
<td>0.03</td>
<td>0.01</td>
<td>0.01</td>
<td>0.02</td>
<td>-0.00</td>
<td>0.03</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2021-04-30</td>
<td>0.03</td>
<td>0.01</td>
<td>0.01</td>
<td>-0.00</td>
<td>0.01</td>
<td>0.02</td>
<td>0.02</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2021-05-31</td>
<td>0.03</td>
<td>0.03</td>
<td>0.03</td>
<td>0.03</td>
<td>0.03</td>
<td>0.02</td>
<td>0.04</td>
</tr>
</tbody>
</table>

<p>376 rows × 7 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="percentage-changes-1" class="level2">
<h2 class="anchored" data-anchor-id="percentage-changes-1">Percentage changes</h2>
<div id="99200683" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>changes.plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4894a799" class="cell" data-execution_count="23">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-size-of-the-changes" class="level2">
<h2 class="anchored" data-anchor-id="the-size-of-the-changes">The size of the changes</h2>
<div class="columns">
<div class="column">
<div id="c27b6e14" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>changes.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>Brisbane      0.005496
East_Bris     0.005416
North_Bris    0.005024
West_Bris     0.004842
Melbourne     0.005677
North_Syd     0.004819
Sydney        0.005526
dtype: float64</code></pre>
</div>
</div>
<div id="82cd034d" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>changes <span class="op">*=</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cff29e34" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>changes.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>Brisbane      0.549605
East_Bris     0.541562
North_Bris    0.502390
West_Bris     0.484204
Melbourne     0.567700
North_Syd     0.481863
Sydney        0.552641
dtype: float64</code></pre>
</div>
</div>
</div><div class="column">
<div id="c7b2f580" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>changes.plot(legend<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="splitting-time-series-data" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Splitting time series data</h1>
<section id="split-without-shuffling" class="level2">
<h2 class="anchored" data-anchor-id="split-without-shuffling">Split <em>without</em> shuffling</h2>
<div id="942bace3" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>num_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.6</span> <span class="op">*</span> <span class="bu">len</span>(changes))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>num_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.2</span> <span class="op">*</span> <span class="bu">len</span>(changes))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>num_test <span class="op">=</span> <span class="bu">len</span>(changes) <span class="op">-</span> num_train <span class="op">-</span> num_val</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"# Train: </span><span class="sc">{</span>num_train<span class="sc">}</span><span class="ss">, # Val: </span><span class="sc">{</span>num_val<span class="sc">}</span><span class="ss">, # Test: </span><span class="sc">{</span>num_test<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Train: 225, # Val: 75, # Test: 76</code></pre>
</div>
</div>
<div id="f9c9d557" class="cell" data-execution_count="30">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="subsequences-of-a-time-series" class="level2">
<h2 class="anchored" data-anchor-id="subsequences-of-a-time-series">Subsequences of a time series</h2>
<p>Keras has a built-in method for converting a time series into subsequences/chunks.</p>
<div id="0ab32e77" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> timeseries_dataset_from_array</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>integers <span class="op">=</span> <span class="bu">range</span>(<span class="dv">10</span>)                                </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>dummy_dataset <span class="op">=</span> timeseries_dataset_from_array(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>integers[:<span class="op">-</span><span class="dv">3</span>],                                 </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>integers[<span class="dv">3</span>:],                               </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span><span class="dv">3</span>,                                      </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">2</span>,                                           </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> inputs, targets <span class="kw">in</span> dummy_dataset:</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(inputs.shape[<span class="dv">0</span>]):</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>([<span class="bu">int</span>(x) <span class="cf">for</span> x <span class="kw">in</span> inputs[i]], <span class="bu">int</span>(targets[i]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0, 1, 2] 3
[1, 2, 3] 4
[2, 3, 4] 5
[3, 4, 5] 6
[4, 5, 6] 7</code></pre>
</div>
</div>
<div class="footer">
<p>Source: Code snippet in Chapter 10 of Chollet.</p>
</div>
</section>
<section id="on-time-series-splits" class="level2">
<h2 class="anchored" data-anchor-id="on-time-series-splits">On time series splits</h2>
<p>If you have a lot of time series data, then use:</p>
<div id="8bc0dcb7" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> timeseries_dataset_from_array</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="bu">range</span>(<span class="dv">20</span>)<span class="op">;</span> seq <span class="op">=</span> <span class="dv">3</span><span class="op">;</span> ts <span class="op">=</span> data[:<span class="op">-</span>seq]<span class="op">;</span> target <span class="op">=</span> data[seq:]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>nTrain <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.5</span> <span class="op">*</span> <span class="bu">len</span>(ts))<span class="op">;</span> nVal <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.25</span> <span class="op">*</span> <span class="bu">len</span>(ts))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>nTest <span class="op">=</span> <span class="bu">len</span>(ts) <span class="op">-</span> nTrain <span class="op">-</span> nVal</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"# Train: </span><span class="sc">{</span>nTrain<span class="sc">}</span><span class="ss">, # Val: </span><span class="sc">{</span>nVal<span class="sc">}</span><span class="ss">, # Test: </span><span class="sc">{</span>nTest<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Train: 8, # Val: 4, # Test: 5</code></pre>
</div>
</div>
<div class="columns">
<div class="column" style="width:33%;">
<div id="e9d680ae" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>trainDS <span class="op">=</span> <span class="op">\</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    ts, target, seq,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    end_index<span class="op">=</span>nTrain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:33%;">
<div id="a8940b2d" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>valDS <span class="op">=</span> <span class="op">\</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    ts, target, seq,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    start_index<span class="op">=</span>nTrain,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    end_index<span class="op">=</span>nTrain<span class="op">+</span>nVal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:33%;">
<div id="98c56e79" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>testDS <span class="op">=</span> <span class="op">\</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    ts, target, seq,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    start_index<span class="op">=</span>nTrain<span class="op">+</span>nVal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:33%;">
<div id="9f42c0b5" class="cell" data-execution_count="37">
<div class="cell-output cell-output-stdout">
<pre><code>Training dataset
[0, 1, 2] 3
[1, 2, 3] 4
[2, 3, 4] 5
[3, 4, 5] 6
[4, 5, 6] 7
[5, 6, 7] 8</code></pre>
</div>
</div>
</div><div class="column" style="width:33%;">
<div id="37b2f050" class="cell" data-execution_count="38">
<div class="cell-output cell-output-stdout">
<pre><code>Validation dataset
[8, 9, 10] 11
[9, 10, 11] 12</code></pre>
</div>
</div>
</div><div class="column" style="width:33%;">
<div id="dd2ccd80" class="cell" data-execution_count="39">
<div class="cell-output cell-output-stdout">
<pre><code>Test dataset
[12, 13, 14] 15
[13, 14, 15] 16
[14, 15, 16] 17</code></pre>
</div>
</div>
</div>
</div>
<div class="footer">
<p>Adapted from: François Chollet (2021), <em>Deep Learning with Python</em>, Second Edition, Listing 10.7.</p>
</div>
</section>
<section id="on-time-series-splits-ii" class="level2">
<h2 class="anchored" data-anchor-id="on-time-series-splits-ii">On time series splits II</h2>
<p>If you <em>don’t</em> have a lot of time series data, consider:</p>
<div id="5cd83104" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> []<span class="op">;</span> y <span class="op">=</span> []</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data)<span class="op">-</span>seq):</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    X.append(data[i:i<span class="op">+</span>seq])</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    y.append(data[i<span class="op">+</span>seq])</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.array(X)<span class="op">;</span> y <span class="op">=</span> np.array(y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="columns">
<div class="column" style="width:33%;">
<div id="dc2affb7" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>nTrain <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.5</span> <span class="op">*</span> X.shape[<span class="dv">0</span>])</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X[:nTrain]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y[:nTrain]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:33%;">
<div id="9b5a9d14" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>nVal <span class="op">=</span> <span class="bu">int</span>(np.ceil(<span class="fl">0.25</span> <span class="op">*</span> X.shape[<span class="dv">0</span>]))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> X[nTrain:nTrain<span class="op">+</span>nVal]</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> y[nTrain:nTrain<span class="op">+</span>nVal]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:33%;">
<div id="caa44087" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>nTest <span class="op">=</span> X.shape[<span class="dv">0</span>] <span class="op">-</span> nTrain <span class="op">-</span> nVal</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X[nTrain<span class="op">+</span>nVal:]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y[nTrain<span class="op">+</span>nVal:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:33%;">
<div id="0686f611" class="cell" data-execution_count="44">
<div class="cell-output cell-output-stdout">
<pre><code>Training dataset
[0, 1, 2] 3
[1, 2, 3] 4
[2, 3, 4] 5
[3, 4, 5] 6
[4, 5, 6] 7
[5, 6, 7] 8
[6, 7, 8] 9
[7, 8, 9] 10</code></pre>
</div>
</div>
</div><div class="column" style="width:33%;">
<div id="44fb92ae" class="cell" data-execution_count="45">
<div class="cell-output cell-output-stdout">
<pre><code>Validation dataset
[8, 9, 10] 11
[9, 10, 11] 12
[10, 11, 12] 13
[11, 12, 13] 14
[12, 13, 14] 15</code></pre>
</div>
</div>
</div><div class="column" style="width:33%;">
<div id="0c67ae45" class="cell" data-execution_count="46">
<div class="cell-output cell-output-stdout">
<pre><code>Test dataset
[13, 14, 15] 16
[14, 15, 16] 17
[15, 16, 17] 18
[16, 17, 18] 19</code></pre>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="predicting-sydney-house-prices" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Predicting Sydney House Prices</h1>
<section id="creating-dataset-objects" class="level2">
<h2 class="anchored" data-anchor-id="creating-dataset-objects">Creating dataset objects</h2>
<div class="columns">
<div class="column">
<div id="4fc9c95f" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Num. of input time series.</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>num_ts <span class="op">=</span> changes.shape[<span class="dv">1</span>]</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># How many prev. months to use.</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>seq_length <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict the next month ahead.</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>ahead <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The index of the first target.</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>delay <span class="op">=</span> (seq_length<span class="op">+</span>ahead<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column">
<div id="683777df" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Which suburb to predict.</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>target_suburb <span class="op">=</span> changes[<span class="st">"Sydney"</span>]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> <span class="op">\</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    changes[:<span class="op">-</span>delay],</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>target_suburb[delay:],</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span>seq_length,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    end_index<span class="op">=</span>num_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="columns">
<div class="column">
<div id="2e741e0d" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> <span class="op">\</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    changes[:<span class="op">-</span>delay],</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>target_suburb[delay:],</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span>seq_length,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    start_index<span class="op">=</span>num_train,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    end_index<span class="op">=</span>num_train<span class="op">+</span>num_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column">
<div id="22e1b7a1" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> <span class="op">\</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    changes[:<span class="op">-</span>delay],</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>target_suburb[delay:],</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span>seq_length,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    start_index<span class="op">=</span>num_train<span class="op">+</span>num_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="converting-dataset-to-numpy" class="level2">
<h2 class="anchored" data-anchor-id="converting-dataset-to-numpy">Converting <code>Dataset</code> to numpy</h2>
<p>The <code>Dataset</code> object can be handed to Keras directly, but if we really need a numpy array, we can run:</p>
<div id="4c9c9d1c" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> np.concatenate(<span class="bu">list</span>(train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: x)))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.concatenate(<span class="bu">list</span>(train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The shape of our training set is now:</p>
<div id="1cbddf40" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>X_train.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>(220, 6, 7)</code></pre>
</div>
</div>
<div id="d1085c0c" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>y_train.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>(220,)</code></pre>
</div>
</div>
<p>Later, we need the targets as numpy arrays:</p>
<div id="293ad66a" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.concatenate(<span class="bu">list</span>(train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> np.concatenate(<span class="bu">list</span>(val_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> np.concatenate(<span class="bu">list</span>(test_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-dense-network" class="level2">
<h2 class="anchored" data-anchor-id="a-dense-network">A dense network</h2>
<div id="1c10c3d9" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Input, Flatten</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>model_dense <span class="op">=</span> Sequential([</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    Flatten(),</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">50</span>, activation<span class="op">=</span><span class="st">"leaky_relu"</span>),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">20</span>, activation<span class="op">=</span><span class="st">"leaky_relu"</span>),</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>model_dense.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"This model has </span><span class="sc">{</span>model_dense<span class="sc">.</span>count_params()<span class="sc">}</span><span class="ss"> parameters."</span>)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_dense.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This model has 3191 parameters.
Epoch 126: early stopping
Restoring model weights from the end of the best epoch: 76.
CPU times: user 6.5 s, sys: 3.77 s, total: 10.3 s
Wall time: 3.47 s</code></pre>
</div>
</div>
</section>
<section id="plot-the-model" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-model">Plot the model</h2>
<div id="34a1b486" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> plot_model</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>plot_model(model_dense, show_shapes<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="assess-the-fits" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits">Assess the fits</h2>
<div id="e99af873" class="cell" data-execution_count="57">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-58-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="dbb92cb3" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model_dense.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>1.3521653413772583</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions">Plotting the predictions</h2>
<div id="853d13d1" class="cell" data-execution_count="59">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-60-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-simplernn-layer" class="level2">
<h2 class="anchored" data-anchor-id="a-simplernn-layer">A <code>SimpleRNN</code> layer</h2>
<div id="6ffec4a8" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>model_simple <span class="op">=</span> Sequential([</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    SimpleRNN(<span class="dv">50</span>),</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>model_simple.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"This model has </span><span class="sc">{</span>model_simple<span class="sc">.</span>count_params()<span class="sc">}</span><span class="ss"> parameters."</span>)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_simple.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This model has 2951 parameters.
Epoch 57: early stopping
Restoring model weights from the end of the best epoch: 7.
CPU times: user 3.12 s, sys: 1.69 s, total: 4.81 s
Wall time: 1.75 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-1" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-1">Assess the fits</h2>
<div id="cfa2b31b" class="cell" data-execution_count="61">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="6cec422a" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>model_simple.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>0.8697079420089722</code></pre>
</div>
</div>
</section>
<section id="plot-the-model-1" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-model-1">Plot the model</h2>
<div id="1c2be82d" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>plot_model(model_simple, show_shapes<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-64-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plotting-the-predictions-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-1">Plotting the predictions</h2>
<div id="7c6db45f" class="cell" data-execution_count="64">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-65-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-lstm-layer" class="level2">
<h2 class="anchored" data-anchor-id="a-lstm-layer">A <code>LSTM</code> layer</h2>
<div id="31ca8729" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LSTM</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>model_lstm <span class="op">=</span> Sequential([</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    LSTM(<span class="dv">50</span>),</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>model_lstm.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_lstm.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 72: early stopping
Restoring model weights from the end of the best epoch: 22.
CPU times: user 4.03 s, sys: 2.09 s, total: 6.11 s
Wall time: 2.37 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-2" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-2">Assess the fits</h2>
<div id="f771abd7" class="cell" data-execution_count="66">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-67-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5c527e6b" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>model_lstm.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>0.8331283330917358</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-2" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-2">Plotting the predictions</h2>
<div id="10786de4" class="cell" data-execution_count="68">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-69-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-gru-layer" class="level2">
<h2 class="anchored" data-anchor-id="a-gru-layer">A <code>GRU</code> layer</h2>
<div id="ab3137be" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> GRU</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>model_gru <span class="op">=</span> Sequential([</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    GRU(<span class="dv">50</span>),</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>model_gru.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_gru.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 66: early stopping
Restoring model weights from the end of the best epoch: 16.
CPU times: user 3.75 s, sys: 1.9 s, total: 5.65 s
Wall time: 2.2 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-3" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-3">Assess the fits</h2>
<div id="298e05bb" class="cell" data-execution_count="70">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-71-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4bb4cc44" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>model_gru.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>0.8188608884811401</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-3" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-3">Plotting the predictions</h2>
<div id="367bb67b" class="cell" data-execution_count="72">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-73-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="two-gru-layers" class="level2">
<h2 class="anchored" data-anchor-id="two-gru-layers">Two <code>GRU</code> layers</h2>
<div id="6249f2c6" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>model_two_grus <span class="op">=</span> Sequential([</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    GRU(<span class="dv">50</span>, return_sequences<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    GRU(<span class="dv">50</span>),</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>model_two_grus.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_two_grus.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 69: early stopping
Restoring model weights from the end of the best epoch: 19.
CPU times: user 4.42 s, sys: 1.99 s, total: 6.41 s
Wall time: 2.86 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-4" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-4">Assess the fits</h2>
<div id="598eab82" class="cell" data-execution_count="74">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-75-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a0144926" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>model_two_grus.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>0.777770459651947</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-4" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-4">Plotting the predictions</h2>
<div id="9f008736" class="cell" data-execution_count="76">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-77-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compare-the-models" class="level2">
<h2 class="anchored" data-anchor-id="compare-the-models">Compare the models</h2>
<div id="38877111" class="cell" data-execution_count="77">
<div class="cell-output cell-output-display" data-execution_count="76">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Model</th>
<th data-quarto-table-cell-role="th">MSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Dense</td>
<td>1.352165</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>SimpleRNN</td>
<td>0.869708</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LSTM</td>
<td>0.833128</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>GRU</td>
<td>0.818861</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2 GRUs</td>
<td>0.777770</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>The network with two GRU layers is the best.</p>
<div id="fe54d1c4" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>model_two_grus.evaluate(test_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>1.9774343967437744</code></pre>
</div>
</div>
</section>
<section id="test-set" class="level2">
<h2 class="anchored" data-anchor-id="test-set">Test set</h2>
<div id="ca35ed8f" class="cell" data-execution_count="79">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-80-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="predicting-multiple-time-series" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Predicting Multiple Time Series</h1>
<section id="creating-dataset-objects-1" class="level2">
<h2 class="anchored" data-anchor-id="creating-dataset-objects-1">Creating dataset objects</h2>
<div class="columns">
<div class="column">
<p>Change the <code>targets</code> argument to include all the suburbs.</p>
</div><div class="column">
<div id="4ece77c6" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> <span class="op">\</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    changes[:<span class="op">-</span>delay],</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>changes[delay:],</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span>seq_length,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    end_index<span class="op">=</span>num_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="columns">
<div class="column">
<div id="60066a99" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> <span class="op">\</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    changes[:<span class="op">-</span>delay],</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>changes[delay:],</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span>seq_length,</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    start_index<span class="op">=</span>num_train,</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    end_index<span class="op">=</span>num_train<span class="op">+</span>num_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column">
<div id="a7bbfd91" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> <span class="op">\</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  timeseries_dataset_from_array(</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    changes[:<span class="op">-</span>delay],</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">=</span>changes[delay:],</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    sequence_length<span class="op">=</span>seq_length,</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    start_index<span class="op">=</span>num_train<span class="op">+</span>num_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="converting-dataset-to-numpy-1" class="level2">
<h2 class="anchored" data-anchor-id="converting-dataset-to-numpy-1">Converting <code>Dataset</code> to numpy</h2>
<p>The shape of our training set is now:</p>
<div id="159aa3f1" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> np.concatenate(<span class="bu">list</span>(train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: x)))</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>X_train.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>(220, 6, 7)</code></pre>
</div>
</div>
<div id="4e88c488" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>Y_train <span class="op">=</span> np.concatenate(<span class="bu">list</span>(train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>Y_train.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>(220, 7)</code></pre>
</div>
</div>
<p>Later, we need the targets as numpy arrays:</p>
<div id="3524e4a0" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>Y_train <span class="op">=</span> np.concatenate(<span class="bu">list</span>(train_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>Y_val <span class="op">=</span> np.concatenate(<span class="bu">list</span>(val_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>Y_test <span class="op">=</span> np.concatenate(<span class="bu">list</span>(test_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-dense-network-1" class="level2">
<h2 class="anchored" data-anchor-id="a-dense-network-1">A dense network</h2>
<div id="23ccaa25" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>model_dense <span class="op">=</span> Sequential([</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    Flatten(),</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">50</span>, activation<span class="op">=</span><span class="st">"leaky_relu"</span>),</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">20</span>, activation<span class="op">=</span><span class="st">"leaky_relu"</span>),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    Dense(num_ts, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>model_dense.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"This model has </span><span class="sc">{</span>model_dense<span class="sc">.</span>count_params()<span class="sc">}</span><span class="ss"> parameters."</span>)</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_dense.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This model has 3317 parameters.
Epoch 96: early stopping
Restoring model weights from the end of the best epoch: 46.
CPU times: user 4.9 s, sys: 2.73 s, total: 7.63 s
Wall time: 2.66 s</code></pre>
</div>
</div>
</section>
<section id="plot-the-model-2" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-model-2">Plot the model</h2>
<div id="ce1079e5" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>plot_model(model_dense, show_shapes<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-88-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="assess-the-fits-5" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-5">Assess the fits</h2>
<div id="d03ee837" class="cell" data-execution_count="88">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-89-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5b28c638" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>model_dense.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>1.445832371711731</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-5" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-5">Plotting the predictions</h2>
<div class="columns">
<div class="column">
<div id="d6201f34" class="cell" data-execution_count="90">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-91-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-91-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column">
<div id="0903b31a" class="cell" data-execution_count="91">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-92-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-92-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="a-simplernn-layer-1" class="level2">
<h2 class="anchored" data-anchor-id="a-simplernn-layer-1">A <code>SimpleRNN</code> layer</h2>
<div id="9df86f59" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>model_simple <span class="op">=</span> Sequential([</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    SimpleRNN(<span class="dv">50</span>),</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    Dense(num_ts, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>model_simple.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"This model has </span><span class="sc">{</span>model_simple<span class="sc">.</span>count_params()<span class="sc">}</span><span class="ss"> parameters."</span>)</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_simple.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This model has 3257 parameters.
Epoch 93: early stopping
Restoring model weights from the end of the best epoch: 43.
CPU times: user 4.98 s, sys: 2.65 s, total: 7.63 s
Wall time: 2.83 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-6" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-6">Assess the fits</h2>
<div id="af6fb02f" class="cell" data-execution_count="93">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-94-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9e5981d9" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>model_simple.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>1.6287589073181152</code></pre>
</div>
</div>
</section>
<section id="plot-the-model-3" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-model-3">Plot the model</h2>
<div id="4970942f" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>plot_model(model_simple, show_shapes<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-96-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plotting-the-predictions-6" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-6">Plotting the predictions</h2>
<div class="columns">
<div class="column">
<div id="efc8a634" class="cell" data-execution_count="96">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-97-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-97-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column">
<div id="fc8fd684" class="cell" data-execution_count="97">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-98-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-98-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="a-lstm-layer-1" class="level2">
<h2 class="anchored" data-anchor-id="a-lstm-layer-1">A <code>LSTM</code> layer</h2>
<div id="21daa1a5" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>model_lstm <span class="op">=</span> Sequential([</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    LSTM(<span class="dv">50</span>),</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    Dense(num_ts, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>model_lstm.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_lstm.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 106: early stopping
Restoring model weights from the end of the best epoch: 56.
CPU times: user 5.91 s, sys: 3.08 s, total: 8.99 s
Wall time: 3.51 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-7" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-7">Assess the fits</h2>
<div id="e667c4d9" class="cell" data-execution_count="99">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-100-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="55053763" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>model_lstm.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>1.3439931869506836</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-7" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-7">Plotting the predictions</h2>
<div class="columns">
<div class="column">
<div id="d307dfd2" class="cell" data-execution_count="101">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-102-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-102-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column">
<div id="ca8a2d12" class="cell" data-execution_count="102">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-103-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-103-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="a-gru-layer-1" class="level2">
<h2 class="anchored" data-anchor-id="a-gru-layer-1">A <code>GRU</code> layer</h2>
<div id="1fdf7f58" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>model_gru <span class="op">=</span> Sequential([</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>    GRU(<span class="dv">50</span>),</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>    Dense(num_ts, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>model_gru.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_gru.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 114: early stopping
Restoring model weights from the end of the best epoch: 64.
CPU times: user 6.47 s, sys: 3.23 s, total: 9.7 s
Wall time: 3.81 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-8" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-8">Assess the fits</h2>
<div id="23f8542e" class="cell" data-execution_count="104">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-105-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="39cc8edf" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>model_gru.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>1.3462404012680054</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-8" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-8">Plotting the predictions</h2>
<div class="columns">
<div class="column">
<div id="c573c4ad" class="cell" data-execution_count="106">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-107-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-107-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column">
<div id="ed51393b" class="cell" data-execution_count="107">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-108-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-108-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="two-gru-layers-1" class="level2">
<h2 class="anchored" data-anchor-id="two-gru-layers-1">Two <code>GRU</code> layers</h2>
<div id="c287afd8" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">1</span>)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>model_two_grus <span class="op">=</span> Sequential([</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    Input((seq_length, num_ts)),</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    GRU(<span class="dv">50</span>, return_sequences<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    GRU(<span class="dv">50</span>),</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>    Dense(num_ts, activation<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>model_two_grus.compile(loss<span class="op">=</span><span class="st">"mse"</span>, optimizer<span class="op">=</span><span class="st">"adam"</span>)</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>es <span class="op">=</span> EarlyStopping(patience<span class="op">=</span><span class="dv">50</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time hist <span class="op">=</span> model_two_grus.fit(train_ds, epochs<span class="op">=</span><span class="dv">1_000</span>, <span class="op">\</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>  validation_data<span class="op">=</span>val_ds, callbacks<span class="op">=</span>[es], verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 93: early stopping
Restoring model weights from the end of the best epoch: 43.
CPU times: user 6.02 s, sys: 2.75 s, total: 8.78 s
Wall time: 3.89 s</code></pre>
</div>
</div>
</section>
<section id="assess-the-fits-9" class="level2">
<h2 class="anchored" data-anchor-id="assess-the-fits-9">Assess the fits</h2>
<div id="ff762744" class="cell" data-execution_count="109">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-110-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7ca882f7" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>model_two_grus.evaluate(val_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>1.3611823320388794</code></pre>
</div>
</div>
</section>
<section id="plotting-the-predictions-9" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="plotting-the-predictions-9">Plotting the predictions</h2>
<div class="columns">
<div class="column">
<div id="7a3994d3" class="cell" data-execution_count="111">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-112-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-112-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column">
<div id="93cb1d2c" class="cell" data-execution_count="112">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-113-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-113-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="compare-the-models-1" class="level2">
<h2 class="anchored" data-anchor-id="compare-the-models-1">Compare the models</h2>
<div id="f7508da3" class="cell" data-execution_count="113">
<div class="cell-output cell-output-display" data-execution_count="112">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Model</th>
<th data-quarto-table-cell-role="th">MSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>SimpleRNN</td>
<td>1.628759</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>Dense</td>
<td>1.445832</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2 GRUs</td>
<td>1.361182</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>GRU</td>
<td>1.346240</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LSTM</td>
<td>1.343993</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>The network with an LSTM layer is the best.</p>
<div id="da196b2e" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>model_lstm.evaluate(test_ds, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>1.879453420639038</code></pre>
</div>
</div>
</section>
<section id="test-set-1" class="level2">
<h2 class="anchored" data-anchor-id="test-set-1">Test set</h2>
<div class="columns">
<div class="column">
<div id="2e20018a" class="cell" data-execution_count="115">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-116-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-116-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column">
<div id="5993603b" class="cell" data-execution_count="116">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-117-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="rnns-and-time-series_files/figure-html/cell-117-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="appendix" class="level1" data-visibility="uncounted">
<h1 data-visibility="uncounted">Appendix</h1>
<section id="package-versions" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="package-versions">Package Versions</h2>
<div id="068a29ce" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> watermark <span class="im">import</span> watermark</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(watermark(python<span class="op">=</span><span class="va">True</span>, packages<span class="op">=</span><span class="st">"keras,matplotlib,numpy,pandas,seaborn,scipy,torch,tensorflow,tf_keras"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Python implementation: CPython
Python version       : 3.11.8
IPython version      : 8.23.0

keras     : 3.2.0
matplotlib: 3.8.4
numpy     : 1.26.4
pandas    : 2.2.1
seaborn   : 0.13.2
scipy     : 1.11.0
torch     : 2.2.2
tensorflow: 2.16.1
tf_keras  : 2.16.0
</code></pre>
</div>
</div>
</section>
<section id="glossary" class="level2" data-visibility="uncounted">
<h2 data-visibility="uncounted" class="anchored" data-anchor-id="glossary">Glossary</h2>
<ul>
<li>GRU</li>
<li>LSTM</li>
<li>recurrent neural networks</li>
<li>SimpleRNN</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../Lecture-6-Uncertainty-Quantification/uncertainty-quantification.html" class="pagination-link" aria-label="Uncertainty Quantification">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Uncertainty Quantification</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../Lecture-8-Generative-Networks/generative-networks.html" class="pagination-link" aria-label="Generative Networks">
        <span class="nav-page-text">Generative Networks</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>